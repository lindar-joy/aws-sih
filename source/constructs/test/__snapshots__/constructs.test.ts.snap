// Jest Snapshot v1, https://goo.gl/fbAQLP

exports[`Serverless Image Handler Stack Snapshot baseline 1`] = `
{
  "Conditions": {
    "CommonResourcesDeployDemoUICondition308D3B09": {
      "Fn::Equals": [
        {
          "Ref": "DeployDemoUIParameter",
        },
        "Yes",
      ],
    },
    "CommonResourcesEnableCorsConditionA0615348": {
      "Fn::Equals": [
        {
          "Ref": "CorsEnabledParameter",
        },
        "Yes",
      ],
    },
    "CommonResourcesEnableDefaultFallbackImageConditionD1A10983": {
      "Fn::Equals": [
        {
          "Ref": "EnableDefaultFallbackImageParameter",
        },
        "Yes",
      ],
    },
    "CommonResourcesEnableSignatureCondition909DC7A1": {
      "Fn::Equals": [
        {
          "Ref": "EnableSignatureParameter",
        },
        "Yes",
      ],
    },
  },
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "CORS Options",
          },
          "Parameters": [
            "CorsEnabledParameter",
            "CorsOriginParameter",
          ],
        },
        {
          "Label": {
            "default": "Image Sources",
          },
          "Parameters": [
            "SourceBucketsParameter",
          ],
        },
        {
          "Label": {
            "default": "Demo UI",
          },
          "Parameters": [
            "DeployDemoUIParameter",
          ],
        },
        {
          "Label": {
            "default": "Event Logging",
          },
          "Parameters": [
            "LogRetentionPeriodParameter",
          ],
        },
        {
          "Label": {
            "default": "Image URL Signature (Note: Enabling signature is not compatible with previous image URLs, which could result in broken image links. Please refer to the implementation guide for details: https://docs.aws.amazon.com/solutions/latest/serverless-image-handler/considerations.html)",
          },
          "Parameters": [
            "EnableSignatureParameter",
            "SecretsManagerSecretParameter",
            "SecretsManagerKeyParameter",
          ],
        },
        {
          "Label": {
            "default": "Default Fallback Image (Note: Enabling default fallback image returns the default fallback image instead of JSON object when error happens. Please refer to the implementation guide for details: https://docs.aws.amazon.com/solutions/latest/serverless-image-handler/considerations.html)",
          },
          "Parameters": [
            "EnableDefaultFallbackImageParameter",
            "FallbackImageS3BucketParameter",
            "FallbackImageS3KeyParameter",
          ],
        },
        {
          "Label": {
            "default": "Auto WebP",
          },
          "Parameters": [
            "AutoWebPParameter",
          ],
        },
      ],
      "ParameterLabels": {
        "AutoWebPParameter": {
          "default": "AutoWebP",
        },
        "CloudFrontPriceClassParameter": {
          "default": "CloudFront PriceClass",
        },
        "CorsEnabledParameter": {
          "default": "CORS Enabled",
        },
        "CorsOriginParameter": {
          "default": "CORS Origin",
        },
        "DeployDemoUIParameter": {
          "default": "Deploy Demo UI",
        },
        "EnableDefaultFallbackImageParameter": {
          "default": "Enable Default Fallback Image",
        },
        "EnableSignatureParameter": {
          "default": "Enable Signature",
        },
        "FallbackImageS3BucketParameter": {
          "default": "Fallback Image S3 Bucket",
        },
        "FallbackImageS3KeyParameter": {
          "default": "Fallback Image S3 Key",
        },
        "LogRetentionPeriodParameter": {
          "default": "Log Retention Period",
        },
        "SecretsManagerKeyParameter": {
          "default": "SecretsManager Key",
        },
        "SecretsManagerSecretParameter": {
          "default": "SecretsManager Secret",
        },
        "SourceBucketsParameter": {
          "default": "Source Buckets",
        },
      },
    },
  },
  "Outputs": {
    "ApiEndpoint": {
      "Description": "Link to API endpoint for sending image requests to.",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://",
            {
              "Fn::GetAtt": [
                "BackEndImageHandlerCloudFrontApiGatewayLambdaCloudFrontToApiGatewayCloudFrontDistribution03AA31B2",
                "DomainName",
              ],
            },
          ],
        ],
      },
    },
    "CorsEnabled": {
      "Description": "Indicates whether Cross-Origin Resource Sharing (CORS) has been enabled for the image handler API.",
      "Value": {
        "Ref": "CorsEnabledParameter",
      },
    },
    "CorsOrigin": {
      "Condition": "CommonResourcesEnableCorsConditionA0615348",
      "Description": "Origin value returned in the Access-Control-Allow-Origin header of image handler API responses.",
      "Value": {
        "Ref": "CorsOriginParameter",
      },
    },
    "DemoUrl": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Description": "Link to the demo user interface for the solution.",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://",
            {
              "Fn::GetAtt": [
                "FrontEndDistributionToS3CloudFrontDistribution15FE13D0",
                "DomainName",
              ],
            },
            "/index.html",
          ],
        ],
      },
    },
    "LogRetentionPeriod": {
      "Description": "Number of days for event logs from Lambda to be retained in CloudWatch.",
      "Value": {
        "Ref": "LogRetentionPeriodParameter",
      },
    },
    "SourceBuckets": {
      "Description": "Amazon S3 bucket location containing original image files.",
      "Value": {
        "Ref": "SourceBucketsParameter",
      },
    },
  },
  "Parameters": {
    "AutoWebPParameter": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Would you like to enable automatic WebP based on accept headers? Select 'Yes' if so.",
      "Type": "String",
    },
    "BootstrapVersion": {
      "Default": "/cdk-bootstrap/hnb659fds/version",
      "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]",
      "Type": "AWS::SSM::Parameter::Value<String>",
    },
    "CloudFrontPriceClassParameter": {
      "AllowedValues": [
        "PriceClass_All",
        "PriceClass_200",
        "PriceClass_100",
      ],
      "Default": "PriceClass_All",
      "Description": "The AWS CloudFront price class to use. For more information see: https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/PriceClass.html",
      "Type": "String",
    },
    "CorsEnabledParameter": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Would you like to enable Cross-Origin Resource Sharing (CORS) for the image handler API? Select 'Yes' if so.",
      "Type": "String",
    },
    "CorsOriginParameter": {
      "Default": "*",
      "Description": "If you selected 'Yes' above, please specify an origin value here. A wildcard (*) value will support any origin. We recommend specifying an origin (i.e. https://example.domain) to restrict cross-site access to your API.",
      "Type": "String",
    },
    "DeployDemoUIParameter": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "Yes",
      "Description": "Would you like to deploy a demo UI to explore the features and capabilities of this solution? This will create an additional Amazon S3 bucket and Amazon CloudFront distribution in your account.",
      "Type": "String",
    },
    "EnableDefaultFallbackImageParameter": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Would you like to enable the default fallback image? If so, select 'Yes' and provide FallbackImageS3Bucket and FallbackImageS3Key values.",
      "Type": "String",
    },
    "EnableSignatureParameter": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Would you like to enable the signature? If so, select 'Yes' and provide SecretsManagerSecret and SecretsManagerKey values.",
      "Type": "String",
    },
    "FallbackImageS3BucketParameter": {
      "Default": "",
      "Description": "The name of the Amazon S3 bucket which contains the default fallback image. e.g. my-fallback-image-bucket",
      "Type": "String",
    },
    "FallbackImageS3KeyParameter": {
      "Default": "",
      "Description": "The name of the default fallback image object key including prefix. e.g. prefix/image.jpg",
      "Type": "String",
    },
    "LogRetentionPeriodParameter": {
      "AllowedValues": [
        "1",
        "3",
        "5",
        "7",
        "14",
        "30",
        "60",
        "90",
        "120",
        "150",
        "180",
        "365",
        "400",
        "545",
        "731",
        "1827",
        "3653",
      ],
      "Default": "1",
      "Description": "This solution automatically logs events to Amazon CloudWatch. Select the amount of time for CloudWatch logs from this solution to be retained (in days).",
      "Type": "Number",
    },
    "SecretsManagerKeyParameter": {
      "Default": "",
      "Description": "The name of AWS Secrets Manager secret key. You need to create secret key with this key name. The secret value would be used to check signature.",
      "Type": "String",
    },
    "SecretsManagerSecretParameter": {
      "Default": "",
      "Description": "The name of AWS Secrets Manager secret. You need to create your secret under this name.",
      "Type": "String",
    },
    "SourceBucketsParameter": {
      "AllowedPattern": ".+",
      "Default": "defaultBucket, bucketNo2, bucketNo3, ...",
      "Description": "(Required) List the buckets (comma-separated) within your account that contain original image files. If you plan to use Thumbor or Custom image requests with this solution, the source bucket for those requests will be the first bucket listed in this field.",
      "Type": "String",
    },
  },
  "Resources": {
    "AppRegistry968496A3": {
      "Properties": {
        "Description": "Service Catalog application to track and manage all your resources for the solution sih",
        "Name": {
          "Fn::Join": [
            "-",
            [
              "AppRegistry",
              {
                "Ref": "AWS::StackName",
              },
              {
                "Ref": "AWS::Region",
              },
              {
                "Ref": "AWS::AccountId",
              },
            ],
          ],
        },
        "Tags": {
          "SolutionId": "S0ABC",
          "Solutions:ApplicationType": "AWS-Solutions",
          "Solutions:SolutionID": "S0ABC",
          "Solutions:SolutionName": "sih",
          "Solutions:SolutionVersion": "v6.2.5",
        },
      },
      "Type": "AWS::ServiceCatalogAppRegistry::Application",
    },
    "AppRegistryAssociation": {
      "Properties": {
        "Application": {
          "Fn::GetAtt": [
            "AppRegistry968496A3",
            "Id",
          ],
        },
        "Resource": {
          "Ref": "AWS::StackId",
        },
        "ResourceType": "CFN_STACK",
      },
      "Type": "AWS::ServiceCatalogAppRegistry::ResourceAssociation",
    },
    "BackEndCachePolicy1DCE9B1B": {
      "Properties": {
        "CachePolicyConfig": {
          "DefaultTTL": 86400,
          "MaxTTL": 31536000,
          "MinTTL": 1,
          "Name": {
            "Fn::Join": [
              "",
              [
                "ServerlessImageHandler-",
                {
                  "Fn::GetAtt": [
                    "CommonResourcesCustomResourcesCustomResourceUuid64E7CCAD",
                    "UUID",
                  ],
                },
              ],
            ],
          },
          "ParametersInCacheKeyAndForwardedToOrigin": {
            "CookiesConfig": {
              "CookieBehavior": "none",
            },
            "EnableAcceptEncodingBrotli": false,
            "EnableAcceptEncodingGzip": false,
            "HeadersConfig": {
              "HeaderBehavior": "whitelist",
              "Headers": [
                "origin",
                "accept",
              ],
            },
            "QueryStringsConfig": {
              "QueryStringBehavior": "whitelist",
              "QueryStrings": [
                "signature",
                "edits",
                "headers",
                "effort",
                "outputFormat",
              ],
            },
          },
        },
      },
      "Type": "AWS::CloudFront::CachePolicy",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaApiAccessLogGroup9B786692": {
      "DeletionPolicy": "Retain",
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W84",
              "reason": "By default CloudWatchLogs LogGroups data is encrypted using the CloudWatch server-side encryption keys (AWS Managed Keys)",
            },
          ],
        },
      },
      "Properties": {
        "RetentionInDays": {
          "Ref": "LogRetentionPeriodParameter",
        },
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::Logs::LogGroup",
      "UpdateReplacePolicy": "Retain",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaCloudFrontToApiGatewayCloudFrontDistribution03AA31B2": {
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W70",
              "reason": "Since the distribution uses the CloudFront domain name, CloudFront automatically sets the security policy to TLSv1 regardless of the value of MinimumProtocolVersion",
            },
          ],
        },
      },
      "Properties": {
        "DistributionConfig": {
          "Comment": "Image Handler Distribution for Serverless Image Handler",
          "CustomErrorResponses": [
            {
              "ErrorCachingMinTTL": 600,
              "ErrorCode": 500,
            },
            {
              "ErrorCachingMinTTL": 600,
              "ErrorCode": 501,
            },
            {
              "ErrorCachingMinTTL": 600,
              "ErrorCode": 502,
            },
            {
              "ErrorCachingMinTTL": 600,
              "ErrorCode": 503,
            },
            {
              "ErrorCachingMinTTL": 600,
              "ErrorCode": 504,
            },
          ],
          "DefaultCacheBehavior": {
            "AllowedMethods": [
              "GET",
              "HEAD",
            ],
            "CachePolicyId": {
              "Ref": "BackEndCachePolicy1DCE9B1B",
            },
            "Compress": true,
            "FunctionAssociations": [
              {
                "EventType": "viewer-request",
                "FunctionARN": {
                  "Fn::GetAtt": [
                    "BackEndNormalizeAcceptHeaderFunctionA8503110",
                    "FunctionARN",
                  ],
                },
              },
            ],
            "OriginRequestPolicyId": {
              "Ref": "BackEndOriginRequestPolicy771345D7",
            },
            "TargetOriginId": "TestStack3BackEndImageHandlerCloudFrontApiGatewayLambdaCloudFrontToApiGatewayCloudFrontDistributionOrigin17F61CCDB",
            "ViewerProtocolPolicy": "https-only",
          },
          "Enabled": true,
          "HttpVersion": "http2",
          "IPV6Enabled": true,
          "Logging": {
            "Bucket": {
              "Fn::Join": [
                "",
                [
                  {
                    "Fn::GetAtt": [
                      "CommonResourcesCustomResourcesLogBucketCustomResource2445A3AB",
                      "BucketName",
                    ],
                  },
                  ".s3.",
                  {
                    "Fn::GetAtt": [
                      "CommonResourcesCustomResourcesLogBucketCustomResource2445A3AB",
                      "Region",
                    ],
                  },
                  ".",
                  {
                    "Ref": "AWS::URLSuffix",
                  },
                ],
              ],
            },
            "Prefix": "api-cloudfront/",
          },
          "Origins": [
            {
              "CustomOriginConfig": {
                "OriginProtocolPolicy": "https-only",
                "OriginSSLProtocols": [
                  "TLSv1.1",
                  "TLSv1.2",
                ],
              },
              "DomainName": {
                "Fn::Join": [
                  "",
                  [
                    {
                      "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
                    },
                    ".execute-api.",
                    {
                      "Ref": "AWS::Region",
                    },
                    ".amazonaws.com",
                  ],
                ],
              },
              "Id": "TestStack3BackEndImageHandlerCloudFrontApiGatewayLambdaCloudFrontToApiGatewayCloudFrontDistributionOrigin17F61CCDB",
              "OriginPath": "/image",
            },
          ],
          "PriceClass": {
            "Ref": "CloudFrontPriceClassParameter",
          },
        },
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::CloudFront::Distribution",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109": {
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W59",
              "reason": "AWS::ApiGateway::Method AuthorizationType is set to 'NONE' because API Gateway behind CloudFront does not support AWS_IAM authentication",
            },
          ],
        },
      },
      "Properties": {
        "BinaryMediaTypes": [
          "*/*",
        ],
        "EndpointConfiguration": {
          "Types": [
            "REGIONAL",
          ],
        },
        "Name": "LambdaRestApi",
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::ApiGateway::RestApi",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiANYApiPermissionTestStack3BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi35311FB9ANYC514F811": {
      "Properties": {
        "Action": "lambda:InvokeFunction",
        "FunctionName": {
          "Fn::GetAtt": [
            "BackEndImageHandlerLambdaFunctionADEF7FF2",
            "Arn",
          ],
        },
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": {
          "Fn::Join": [
            "",
            [
              "arn:",
              {
                "Ref": "AWS::Partition",
              },
              ":execute-api:",
              {
                "Ref": "AWS::Region",
              },
              ":",
              {
                "Ref": "AWS::AccountId",
              },
              ":",
              {
                "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
              },
              "/",
              {
                "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiDeploymentStageimageB55D20E3",
              },
              "/*/",
            ],
          ],
        },
      },
      "Type": "AWS::Lambda::Permission",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiANYApiPermissionTestTestStack3BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi35311FB9ANY7924B8F2": {
      "Properties": {
        "Action": "lambda:InvokeFunction",
        "FunctionName": {
          "Fn::GetAtt": [
            "BackEndImageHandlerLambdaFunctionADEF7FF2",
            "Arn",
          ],
        },
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": {
          "Fn::Join": [
            "",
            [
              "arn:",
              {
                "Ref": "AWS::Partition",
              },
              ":execute-api:",
              {
                "Ref": "AWS::Region",
              },
              ":",
              {
                "Ref": "AWS::AccountId",
              },
              ":",
              {
                "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
              },
              "/test-invoke-stage/*/",
            ],
          ],
        },
      },
      "Type": "AWS::Lambda::Permission",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiANYE4494B31": {
      "Properties": {
        "AuthorizationType": "NONE",
        "HttpMethod": "ANY",
        "Integration": {
          "IntegrationHttpMethod": "POST",
          "Type": "AWS_PROXY",
          "Uri": {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":apigateway:",
                {
                  "Ref": "AWS::Region",
                },
                ":lambda:path/2015-03-31/functions/",
                {
                  "Fn::GetAtt": [
                    "BackEndImageHandlerLambdaFunctionADEF7FF2",
                    "Arn",
                  ],
                },
                "/invocations",
              ],
            ],
          },
        },
        "ResourceId": {
          "Fn::GetAtt": [
            "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
            "RootResourceId",
          ],
        },
        "RestApiId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
        },
      },
      "Type": "AWS::ApiGateway::Method",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiAccountE5522E5D": {
      "DependsOn": [
        "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
      ],
      "Properties": {
        "CloudWatchRoleArn": {
          "Fn::GetAtt": [
            "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiCloudWatchRole12575C4D",
            "Arn",
          ],
        },
      },
      "Type": "AWS::ApiGateway::Account",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiCloudWatchRole12575C4D": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "apigateway.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "Policies": [
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:DescribeLogGroups",
                    "logs:DescribeLogStreams",
                    "logs:PutLogEvents",
                    "logs:GetLogEvents",
                    "logs:FilterLogEvents",
                  ],
                  "Effect": "Allow",
                  "Resource": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:",
                        {
                          "Ref": "AWS::Partition",
                        },
                        ":logs:",
                        {
                          "Ref": "AWS::Region",
                        },
                        ":",
                        {
                          "Ref": "AWS::AccountId",
                        },
                        ":*",
                      ],
                    ],
                  },
                },
              ],
              "Version": "2012-10-17",
            },
            "PolicyName": "LambdaRestApiCloudWatchRolePolicy",
          },
        ],
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiDeployment663240D6bb2931f4d7f47b51b7b40b3fd0d7001b": {
      "DependsOn": [
        "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyANY8F9763E1",
        "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyBDF0A131",
        "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiANYE4494B31",
      ],
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W45",
              "reason": "ApiGateway has AccessLogging enabled in AWS::ApiGateway::Stage resource, but cfn_nag checks for it in AWS::ApiGateway::Deployment resource",
            },
          ],
        },
      },
      "Properties": {
        "Description": "Automatically created by the RestApi construct",
        "RestApiId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
        },
      },
      "Type": "AWS::ApiGateway::Deployment",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiDeploymentStageimageB55D20E3": {
      "Properties": {
        "AccessLogSetting": {
          "DestinationArn": {
            "Fn::GetAtt": [
              "BackEndImageHandlerCloudFrontApiGatewayLambdaApiAccessLogGroup9B786692",
              "Arn",
            ],
          },
          "Format": "{"requestId":"$context.requestId","ip":"$context.identity.sourceIp","user":"$context.identity.user","caller":"$context.identity.caller","requestTime":"$context.requestTime","httpMethod":"$context.httpMethod","resourcePath":"$context.resourcePath","status":"$context.status","protocol":"$context.protocol","responseLength":"$context.responseLength"}",
        },
        "DeploymentId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiDeployment663240D6bb2931f4d7f47b51b7b40b3fd0d7001b",
        },
        "MethodSettings": [
          {
            "DataTraceEnabled": false,
            "HttpMethod": "*",
            "LoggingLevel": "INFO",
            "ResourcePath": "/*",
          },
        ],
        "RestApiId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
        },
        "StageName": "image",
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
        "TracingEnabled": true,
      },
      "Type": "AWS::ApiGateway::Stage",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiUsagePlan76CA1E70": {
      "Properties": {
        "ApiStages": [
          {
            "ApiId": {
              "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
            },
            "Stage": {
              "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiDeploymentStageimageB55D20E3",
            },
            "Throttle": {},
          },
        ],
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::ApiGateway::UsagePlan",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyANY8F9763E1": {
      "Properties": {
        "AuthorizationType": "NONE",
        "HttpMethod": "ANY",
        "Integration": {
          "IntegrationHttpMethod": "POST",
          "Type": "AWS_PROXY",
          "Uri": {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":apigateway:",
                {
                  "Ref": "AWS::Region",
                },
                ":lambda:path/2015-03-31/functions/",
                {
                  "Fn::GetAtt": [
                    "BackEndImageHandlerLambdaFunctionADEF7FF2",
                    "Arn",
                  ],
                },
                "/invocations",
              ],
            ],
          },
        },
        "ResourceId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyBDF0A131",
        },
        "RestApiId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
        },
      },
      "Type": "AWS::ApiGateway::Method",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyANYApiPermissionTestStack3BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi35311FB9ANYproxy87B7DA48": {
      "Properties": {
        "Action": "lambda:InvokeFunction",
        "FunctionName": {
          "Fn::GetAtt": [
            "BackEndImageHandlerLambdaFunctionADEF7FF2",
            "Arn",
          ],
        },
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": {
          "Fn::Join": [
            "",
            [
              "arn:",
              {
                "Ref": "AWS::Partition",
              },
              ":execute-api:",
              {
                "Ref": "AWS::Region",
              },
              ":",
              {
                "Ref": "AWS::AccountId",
              },
              ":",
              {
                "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
              },
              "/",
              {
                "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiDeploymentStageimageB55D20E3",
              },
              "/*/*",
            ],
          ],
        },
      },
      "Type": "AWS::Lambda::Permission",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyANYApiPermissionTestTestStack3BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi35311FB9ANYproxyFD69140A": {
      "Properties": {
        "Action": "lambda:InvokeFunction",
        "FunctionName": {
          "Fn::GetAtt": [
            "BackEndImageHandlerLambdaFunctionADEF7FF2",
            "Arn",
          ],
        },
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": {
          "Fn::Join": [
            "",
            [
              "arn:",
              {
                "Ref": "AWS::Partition",
              },
              ":execute-api:",
              {
                "Ref": "AWS::Region",
              },
              ":",
              {
                "Ref": "AWS::AccountId",
              },
              ":",
              {
                "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
              },
              "/test-invoke-stage/*/*",
            ],
          ],
        },
      },
      "Type": "AWS::Lambda::Permission",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyBDF0A131": {
      "Properties": {
        "ParentId": {
          "Fn::GetAtt": [
            "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
            "RootResourceId",
          ],
        },
        "PathPart": "{proxy+}",
        "RestApiId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
        },
      },
      "Type": "AWS::ApiGateway::Resource",
    },
    "BackEndImageHandlerFunctionPolicy437940B5": {
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W12",
              "reason": "rekognition:DetectFaces requires '*' resources.",
            },
          ],
        },
      },
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents",
              ],
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition",
                    },
                    ":logs:",
                    {
                      "Ref": "AWS::Region",
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    ":log-group:/aws/lambda/*",
                  ],
                ],
              },
            },
            {
              "Action": [
                "s3:GetObject",
                "s3:PutObject",
                "s3:ListBucket",
              ],
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition",
                    },
                    ":s3:::*",
                  ],
                ],
              },
            },
            {
              "Action": [
                "rekognition:DetectFaces",
                "rekognition:DetectModerationLabels",
              ],
              "Effect": "Allow",
              "Resource": "*",
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "BackEndImageHandlerFunctionPolicy437940B5",
        "Roles": [
          {
            "Ref": "BackEndImageHandlerFunctionRoleABF81E5C",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "BackEndImageHandlerFunctionRoleABF81E5C": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "BackEndImageHandlerLambdaFunctionADEF7FF2": {
      "DependsOn": [
        "BackEndImageHandlerFunctionRoleABF81E5C",
      ],
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W58",
              "reason": "The function does have permission to write CloudWatch Logs.",
            },
            {
              "id": "W89",
              "reason": "The Lambda function does not require any VPC connection at all.",
            },
            {
              "id": "W92",
              "reason": "The Lambda function does not require ReservedConcurrentExecutions.",
            },
          ],
        },
      },
      "Properties": {
        "Code": {
          "S3Bucket": {
            "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-\${AWS::Region}",
          },
          "S3Key": "Omitted to remove snapshot dependency on hash",
        },
        "Description": "sih (v6.2.5): Performs image edits and manipulations",
        "Environment": {
          "Variables": {
            "AUTO_WEBP": {
              "Ref": "AutoWebPParameter",
            },
            "AWS_NODEJS_CONNECTION_REUSE_ENABLED": "1",
            "CORS_ENABLED": {
              "Ref": "CorsEnabledParameter",
            },
            "CORS_ORIGIN": {
              "Ref": "CorsOriginParameter",
            },
            "DEFAULT_FALLBACK_IMAGE_BUCKET": {
              "Ref": "FallbackImageS3BucketParameter",
            },
            "DEFAULT_FALLBACK_IMAGE_KEY": {
              "Ref": "FallbackImageS3KeyParameter",
            },
            "ENABLE_DEFAULT_FALLBACK_IMAGE": {
              "Ref": "EnableDefaultFallbackImageParameter",
            },
            "ENABLE_SIGNATURE": {
              "Ref": "EnableSignatureParameter",
            },
            "REWRITE_MATCH_PATTERN": "",
            "REWRITE_SUBSTITUTION": "",
            "SECRETS_MANAGER": {
              "Ref": "SecretsManagerSecretParameter",
            },
            "SECRET_KEY": {
              "Ref": "SecretsManagerKeyParameter",
            },
            "SOURCE_BUCKETS": {
              "Ref": "SourceBucketsParameter",
            },
          },
        },
        "Handler": "index.handler",
        "MemorySize": 1024,
        "Role": {
          "Fn::GetAtt": [
            "BackEndImageHandlerFunctionRoleABF81E5C",
            "Arn",
          ],
        },
        "Runtime": "nodejs20.x",
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
        "Timeout": 29,
      },
      "Type": "AWS::Lambda::Function",
    },
    "BackEndImageHandlerLogGroupA0941EEC": {
      "DeletionPolicy": "Retain",
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W84",
              "reason": "CloudWatch log group is always encrypted by default.",
            },
          ],
        },
      },
      "Properties": {
        "LogGroupName": {
          "Fn::Join": [
            "",
            [
              "/aws/lambda/",
              {
                "Ref": "BackEndImageHandlerLambdaFunctionADEF7FF2",
              },
            ],
          ],
        },
        "RetentionInDays": {
          "Ref": "LogRetentionPeriodParameter",
        },
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::Logs::LogGroup",
      "UpdateReplacePolicy": "Retain",
    },
    "BackEndNormalizeAcceptHeaderFunctionA8503110": {
      "Properties": {
        "AutoPublish": true,
        "FunctionCode": "
function handler(event) {
  if (event.request.headers && event.request.headers.accept && event.request.headers.accept.value) {
    let resultingHeader = "image/jpg";
    const acceptheadervalue = event.request.headers.accept.value;
    if (acceptheadervalue.includes("image/webp")) {
      resultingHeader = "image/webp";
    }
    event.request.headers.accept = { value: resultingHeader };
  }
  return event.request;
}
",
        "FunctionConfig": {
          "Comment": {
            "Fn::Join": [
              "",
              [
                "normalize-accept-headers-",
                {
                  "Ref": "AWS::Region",
                },
              ],
            ],
          },
          "Runtime": "cloudfront-js-1.0",
        },
        "Name": {
          "Fn::Join": [
            "",
            [
              "normalize-accept-headers-",
              {
                "Ref": "AWS::Region",
              },
            ],
          ],
        },
      },
      "Type": "AWS::CloudFront::Function",
    },
    "BackEndOriginRequestPolicy771345D7": {
      "Properties": {
        "OriginRequestPolicyConfig": {
          "CookiesConfig": {
            "CookieBehavior": "none",
          },
          "HeadersConfig": {
            "HeaderBehavior": "whitelist",
            "Headers": [
              "origin",
              "accept",
            ],
          },
          "Name": {
            "Fn::Join": [
              "",
              [
                "ServerlessImageHandler-",
                {
                  "Fn::GetAtt": [
                    "CommonResourcesCustomResourcesCustomResourceUuid64E7CCAD",
                    "UUID",
                  ],
                },
              ],
            ],
          },
          "QueryStringsConfig": {
            "QueryStringBehavior": "whitelist",
            "QueryStrings": [
              "signature",
              "edits",
              "headers",
              "effort",
              "outputFormat",
            ],
          },
        },
      },
      "Type": "AWS::CloudFront::OriginRequestPolicy",
    },
    "CommonResourcesCustomResourcesCustomResourceAnonymousMetric51363F57": {
      "DeletionPolicy": "Delete",
      "Properties": {
        "AnonymousData": "No",
        "AutoWebP": {
          "Ref": "AutoWebPParameter",
        },
        "CorsEnabled": {
          "Ref": "CorsEnabledParameter",
        },
        "CustomAction": "sendMetric",
        "DeployDemoUi": {
          "Ref": "DeployDemoUIParameter",
        },
        "EnableDefaultFallbackImage": {
          "Ref": "EnableDefaultFallbackImageParameter",
        },
        "EnableSignature": {
          "Ref": "EnableSignatureParameter",
        },
        "LogRetentionPeriod": {
          "Ref": "LogRetentionPeriodParameter",
        },
        "Region": {
          "Ref": "AWS::Region",
        },
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
        "SourceBuckets": {
          "Ref": "SourceBucketsParameter",
        },
        "UUID": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceUuid64E7CCAD",
            "UUID",
          ],
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesCustomResourceCheckFallbackImage6CE45571": {
      "Condition": "CommonResourcesEnableDefaultFallbackImageConditionD1A10983",
      "DeletionPolicy": "Delete",
      "Properties": {
        "CustomAction": "checkFallbackImage",
        "FallbackImageS3Bucket": {
          "Ref": "FallbackImageS3BucketParameter",
        },
        "FallbackImageS3Key": {
          "Ref": "FallbackImageS3KeyParameter",
        },
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesCustomResourceCheckSecretsManagerAEEEC776": {
      "Condition": "CommonResourcesEnableSignatureCondition909DC7A1",
      "DeletionPolicy": "Delete",
      "Properties": {
        "CustomAction": "checkSecretsManager",
        "SecretsManagerKey": {
          "Ref": "SecretsManagerKeyParameter",
        },
        "SecretsManagerName": {
          "Ref": "SecretsManagerSecretParameter",
        },
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesCustomResourceCheckSourceBucketsA313C9B7": {
      "DeletionPolicy": "Delete",
      "Properties": {
        "CustomAction": "checkSourceBuckets",
        "Region": {
          "Ref": "AWS::Region",
        },
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
        "SourceBuckets": {
          "Ref": "SourceBucketsParameter",
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesCustomResourceFunction0D924235": {
      "DependsOn": [
        "CommonResourcesCustomResourcesCustomResourceRole8958A1ED",
      ],
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W58",
              "reason": "The function does have permission to write CloudWatch Logs.",
            },
            {
              "id": "W89",
              "reason": "The Lambda function does not require any VPC connection at all.",
            },
            {
              "id": "W92",
              "reason": "The Lambda function does not require ReservedConcurrentExecutions.",
            },
          ],
        },
      },
      "Properties": {
        "Code": {
          "S3Bucket": {
            "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-\${AWS::Region}",
          },
          "S3Key": "Omitted to remove snapshot dependency on hash",
        },
        "Description": "sih (v6.2.5): Custom resource",
        "Environment": {
          "Variables": {
            "AWS_NODEJS_CONNECTION_REUSE_ENABLED": "1",
            "RETRY_SECONDS": "5",
            "SOLUTION_ID": "S0ABC",
            "SOLUTION_VERSION": "v6.2.5",
          },
        },
        "Handler": "index.handler",
        "MemorySize": 128,
        "Role": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceRole8958A1ED",
            "Arn",
          ],
        },
        "Runtime": "nodejs20.x",
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
        "Timeout": 60,
      },
      "Type": "AWS::Lambda::Function",
    },
    "CommonResourcesCustomResourcesCustomResourceRole8958A1ED": {
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W11",
              "reason": "Allow '*' because it is required for making DescribeRegions API call as it doesn't support resource-level permissions and require to choose all resources.",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "Path": "/",
        "Policies": [
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents",
                  ],
                  "Effect": "Allow",
                  "Resource": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:",
                        {
                          "Ref": "AWS::Partition",
                        },
                        ":logs:",
                        {
                          "Ref": "AWS::Region",
                        },
                        ":",
                        {
                          "Ref": "AWS::AccountId",
                        },
                        ":log-group:/aws/lambda/*",
                      ],
                    ],
                  },
                },
                {
                  "Action": [
                    "s3:putBucketAcl",
                    "s3:putEncryptionConfiguration",
                    "s3:putBucketPolicy",
                    "s3:CreateBucket",
                    "s3:GetObject",
                    "s3:PutObject",
                    "s3:ListBucket",
                    "s3:PutBucketOwnershipControls",
                  ],
                  "Effect": "Allow",
                  "Resource": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:",
                        {
                          "Ref": "AWS::Partition",
                        },
                        ":s3:::*",
                      ],
                    ],
                  },
                },
              ],
              "Version": "2012-10-17",
            },
            "PolicyName": "CloudWatchLogsPolicy",
          },
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": "ec2:DescribeRegions",
                  "Effect": "Allow",
                  "Resource": "*",
                },
              ],
              "Version": "2012-10-17",
            },
            "PolicyName": "EC2Policy",
          },
        ],
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "CommonResourcesCustomResourcesCustomResourceUuid64E7CCAD": {
      "DeletionPolicy": "Delete",
      "Properties": {
        "CustomAction": "createUuid",
        "Region": {
          "Ref": "AWS::Region",
        },
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesDeployWebsiteAwsCliLayerBC025F39": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Properties": {
        "Content": {
          "S3Bucket": {
            "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-\${AWS::Region}",
          },
          "S3Key": "Omitted to remove snapshot dependency on hash",
        },
        "Description": "/opt/awscli/aws",
      },
      "Type": "AWS::Lambda::LayerVersion",
    },
    "CommonResourcesCustomResourcesDeployWebsiteCustomResourceECB9B136": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "DeletionPolicy": "Delete",
      "Properties": {
        "DestinationBucketName": {
          "Ref": "FrontEndDistributionToS3S3Bucket3A171D78",
        },
        "Exclude": [
          "demo-ui-config.js",
        ],
        "Prune": true,
        "ServiceToken": {
          "Fn::GetAtt": [
            "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756C81C01536",
            "Arn",
          ],
        },
        "SourceBucketNames": [
          {
            "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-\${AWS::Region}",
          },
        ],
        "SourceObjectKeys": [
          "c301c2cce52bb1b36720a115d657907f3ec9fa20bd385b4d81bf451fbe77fe4b.zip",
        ],
      },
      "Type": "Custom::CDKBucketDeployment",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesLogBucketCustomResource2445A3AB": {
      "DeletionPolicy": "Delete",
      "Properties": {
        "BucketSuffix": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AWS::StackName",
              },
              "-",
              {
                "Ref": "AWS::Region",
              },
              "-",
              {
                "Ref": "AWS::AccountId",
              },
            ],
          ],
        },
        "CustomAction": "createCloudFrontLoggingBucket",
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesPutWebsiteConfigC4E435F3": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "DeletionPolicy": "Delete",
      "Properties": {
        "ConfigItem": {
          "apiEndpoint": {
            "Fn::Join": [
              "",
              [
                "https://",
                {
                  "Fn::GetAtt": [
                    "BackEndImageHandlerCloudFrontApiGatewayLambdaCloudFrontToApiGatewayCloudFrontDistribution03AA31B2",
                    "DomainName",
                  ],
                },
              ],
            ],
          },
        },
        "CustomAction": "putConfigFile",
        "DestS3Bucket": {
          "Ref": "FrontEndDistributionToS3S3Bucket3A171D78",
        },
        "DestS3key": "demo-ui-config.js",
        "Region": {
          "Ref": "AWS::Region",
        },
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesSecretsManagerPolicy45FE005E": {
      "Condition": "CommonResourcesEnableSignatureCondition909DC7A1",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "secretsmanager:GetSecretValue",
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition",
                    },
                    ":secretsmanager:",
                    {
                      "Ref": "AWS::Region",
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    ":secret:",
                    {
                      "Ref": "SecretsManagerSecretParameter",
                    },
                    "*",
                  ],
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "CommonResourcesSecretsManagerPolicy45FE005E",
        "Roles": [
          {
            "Ref": "CommonResourcesCustomResourcesCustomResourceRole8958A1ED",
          },
          {
            "Ref": "BackEndImageHandlerFunctionRoleABF81E5C",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756C81C01536": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "DependsOn": [
        "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRoleDefaultPolicy88902FDF",
        "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRole89A01265",
      ],
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W58",
              "reason": "The function does have permission to write CloudWatch Logs.",
            },
            {
              "id": "W89",
              "reason": "The Lambda function does not require any VPC connection at all.",
            },
            {
              "id": "W92",
              "reason": "The Lambda function does not require ReservedConcurrentExecutions.",
            },
          ],
        },
      },
      "Properties": {
        "Code": {
          "S3Bucket": {
            "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-\${AWS::Region}",
          },
          "S3Key": "Omitted to remove snapshot dependency on hash",
        },
        "Environment": {
          "Variables": {
            "AWS_CA_BUNDLE": "/etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem",
          },
        },
        "Handler": "index.handler",
        "Layers": [
          {
            "Ref": "CommonResourcesCustomResourcesDeployWebsiteAwsCliLayerBC025F39",
          },
        ],
        "Role": {
          "Fn::GetAtt": [
            "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRole89A01265",
            "Arn",
          ],
        },
        "Runtime": "python3.9",
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
        "Timeout": 900,
      },
      "Type": "AWS::Lambda::Function",
    },
    "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRole89A01265": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
        ],
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRoleDefaultPolicy88902FDF": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "s3:GetObject*",
                "s3:GetBucket*",
                "s3:List*",
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-\${AWS::Region}",
                      },
                    ],
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-\${AWS::Region}",
                      },
                      "/*",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": [
                "s3:GetObject*",
                "s3:GetBucket*",
                "s3:List*",
                "s3:DeleteObject*",
                "s3:PutObject",
                "s3:PutObjectLegalHold",
                "s3:PutObjectRetention",
                "s3:PutObjectTagging",
                "s3:PutObjectVersionTagging",
                "s3:Abort*",
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "FrontEndDistributionToS3S3Bucket3A171D78",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "FrontEndDistributionToS3S3Bucket3A171D78",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRoleDefaultPolicy88902FDF",
        "Roles": [
          {
            "Ref": "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRole89A01265",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "DefaultApplicationAttributeGroup41AD7209": {
      "Properties": {
        "Attributes": {
          "applicationType": "AWS-Solutions",
          "solutionID": "S0ABC",
          "solutionName": "sih",
          "version": "v6.2.5",
        },
        "Description": "Attribute group for solution information",
        "Name": {
          "Fn::Join": [
            "",
            [
              "A30-AppRegistry-",
              {
                "Ref": "AWS::StackName",
              },
            ],
          ],
        },
        "Tags": {
          "SolutionId": "S0ABC",
        },
      },
      "Type": "AWS::ServiceCatalogAppRegistry::AttributeGroup",
    },
    "DefaultApplicationAttributeGroupApplicationAttributeGroupAssociation4a8eac8f37c1AF4A298D": {
      "Properties": {
        "Application": {
          "Fn::GetAtt": [
            "AppRegistry968496A3",
            "Id",
          ],
        },
        "AttributeGroup": {
          "Fn::GetAtt": [
            "DefaultApplicationAttributeGroup41AD7209",
            "Id",
          ],
        },
      },
      "Type": "AWS::ServiceCatalogAppRegistry::AttributeGroupAssociation",
    },
    "FrontEndDistributionToS3CloudFrontDistribution15FE13D0": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W70",
              "reason": "Since the distribution uses the CloudFront domain name, CloudFront automatically sets the security policy to TLSv1 regardless of the value of MinimumProtocolVersion",
            },
          ],
        },
      },
      "Properties": {
        "DistributionConfig": {
          "Comment": "Demo UI Distribution for Serverless Image Handler",
          "CustomErrorResponses": [
            {
              "ErrorCode": 403,
              "ResponseCode": 200,
              "ResponsePagePath": "/index.html",
            },
            {
              "ErrorCode": 404,
              "ResponseCode": 200,
              "ResponsePagePath": "/index.html",
            },
          ],
          "DefaultCacheBehavior": {
            "CachePolicyId": "658327ea-f89d-4fab-a63d-7e88639e58f6",
            "Compress": true,
            "TargetOriginId": "TestStack3FrontEndDistributionToS3CloudFrontDistributionOrigin1D3513CFC",
            "ViewerProtocolPolicy": "redirect-to-https",
          },
          "DefaultRootObject": "index.html",
          "Enabled": true,
          "HttpVersion": "http2",
          "IPV6Enabled": true,
          "Logging": {
            "Bucket": {
              "Fn::Join": [
                "",
                [
                  {
                    "Fn::GetAtt": [
                      "CommonResourcesCustomResourcesLogBucketCustomResource2445A3AB",
                      "BucketName",
                    ],
                  },
                  ".s3.",
                  {
                    "Fn::GetAtt": [
                      "CommonResourcesCustomResourcesLogBucketCustomResource2445A3AB",
                      "Region",
                    ],
                  },
                  ".",
                  {
                    "Ref": "AWS::URLSuffix",
                  },
                ],
              ],
            },
            "Prefix": "ui-cloudfront/",
          },
          "Origins": [
            {
              "DomainName": {
                "Fn::GetAtt": [
                  "FrontEndDistributionToS3S3Bucket3A171D78",
                  "RegionalDomainName",
                ],
              },
              "Id": "TestStack3FrontEndDistributionToS3CloudFrontDistributionOrigin1D3513CFC",
              "S3OriginConfig": {
                "OriginAccessIdentity": {
                  "Fn::Join": [
                    "",
                    [
                      "origin-access-identity/cloudfront/",
                      {
                        "Ref": "FrontEndDistributionToS3CloudFrontDistributionOrigin1S3OriginD10E575E",
                      },
                    ],
                  ],
                },
              },
            },
          ],
        },
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::CloudFront::Distribution",
    },
    "FrontEndDistributionToS3CloudFrontDistributionOrigin1S3OriginD10E575E": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Properties": {
        "CloudFrontOriginAccessIdentityConfig": {
          "Comment": "Identity for TestStack3FrontEndDistributionToS3CloudFrontDistributionOrigin1D3513CFC",
        },
      },
      "Type": "AWS::CloudFront::CloudFrontOriginAccessIdentity",
    },
    "FrontEndDistributionToS3S3Bucket3A171D78": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "DeletionPolicy": "Retain",
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W35",
              "reason": "This S3 bucket does not require access logging.",
            },
          ],
        },
      },
      "Properties": {
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256",
              },
            },
          ],
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "NoncurrentVersionTransitions": [
                {
                  "StorageClass": "GLACIER",
                  "TransitionInDays": 90,
                },
              ],
              "Status": "Enabled",
            },
          ],
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true,
        },
        "Tags": [
          {
            "Key": "aws-cdk:cr-owned:88ffdb2b",
            "Value": "true",
          },
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
        "VersioningConfiguration": {
          "Status": "Enabled",
        },
      },
      "Type": "AWS::S3::Bucket",
      "UpdateReplacePolicy": "Retain",
    },
    "FrontEndDistributionToS3S3BucketPolicyF3A0315A": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "F16",
              "reason": "Public website bucket policy requires a wildcard principal",
            },
          ],
        },
      },
      "Properties": {
        "Bucket": {
          "Ref": "FrontEndDistributionToS3S3Bucket3A171D78",
        },
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:*",
              "Condition": {
                "Bool": {
                  "aws:SecureTransport": "false",
                },
              },
              "Effect": "Deny",
              "Principal": {
                "AWS": "*",
              },
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "FrontEndDistributionToS3S3Bucket3A171D78",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "FrontEndDistributionToS3S3Bucket3A171D78",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": "s3:GetObject",
              "Effect": "Allow",
              "Principal": {
                "CanonicalUser": {
                  "Fn::GetAtt": [
                    "FrontEndDistributionToS3CloudFrontDistributionOrigin1S3OriginD10E575E",
                    "S3CanonicalUserId",
                  ],
                },
              },
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    {
                      "Fn::GetAtt": [
                        "FrontEndDistributionToS3S3Bucket3A171D78",
                        "Arn",
                      ],
                    },
                    "/*",
                  ],
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::S3::BucketPolicy",
    },
  },
  "Rules": {
    "CheckBootstrapVersion": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Contains": [
                  [
                    "1",
                    "2",
                    "3",
                    "4",
                    "5",
                  ],
                  {
                    "Ref": "BootstrapVersion",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI.",
        },
      ],
    },
  },
}
`;

exports[`Serverless Image Handler Stack Snapshot with Origin Shield 1`] = `
{
  "Conditions": {
    "CommonResourcesDeployDemoUICondition308D3B09": {
      "Fn::Equals": [
        {
          "Ref": "DeployDemoUIParameter",
        },
        "Yes",
      ],
    },
    "CommonResourcesEnableCorsConditionA0615348": {
      "Fn::Equals": [
        {
          "Ref": "CorsEnabledParameter",
        },
        "Yes",
      ],
    },
    "CommonResourcesEnableDefaultFallbackImageConditionD1A10983": {
      "Fn::Equals": [
        {
          "Ref": "EnableDefaultFallbackImageParameter",
        },
        "Yes",
      ],
    },
    "CommonResourcesEnableSignatureCondition909DC7A1": {
      "Fn::Equals": [
        {
          "Ref": "EnableSignatureParameter",
        },
        "Yes",
      ],
    },
  },
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "CORS Options",
          },
          "Parameters": [
            "CorsEnabledParameter",
            "CorsOriginParameter",
          ],
        },
        {
          "Label": {
            "default": "Image Sources",
          },
          "Parameters": [
            "SourceBucketsParameter",
          ],
        },
        {
          "Label": {
            "default": "Demo UI",
          },
          "Parameters": [
            "DeployDemoUIParameter",
          ],
        },
        {
          "Label": {
            "default": "Event Logging",
          },
          "Parameters": [
            "LogRetentionPeriodParameter",
          ],
        },
        {
          "Label": {
            "default": "Image URL Signature (Note: Enabling signature is not compatible with previous image URLs, which could result in broken image links. Please refer to the implementation guide for details: https://docs.aws.amazon.com/solutions/latest/serverless-image-handler/considerations.html)",
          },
          "Parameters": [
            "EnableSignatureParameter",
            "SecretsManagerSecretParameter",
            "SecretsManagerKeyParameter",
          ],
        },
        {
          "Label": {
            "default": "Default Fallback Image (Note: Enabling default fallback image returns the default fallback image instead of JSON object when error happens. Please refer to the implementation guide for details: https://docs.aws.amazon.com/solutions/latest/serverless-image-handler/considerations.html)",
          },
          "Parameters": [
            "EnableDefaultFallbackImageParameter",
            "FallbackImageS3BucketParameter",
            "FallbackImageS3KeyParameter",
          ],
        },
        {
          "Label": {
            "default": "Auto WebP",
          },
          "Parameters": [
            "AutoWebPParameter",
          ],
        },
      ],
      "ParameterLabels": {
        "AutoWebPParameter": {
          "default": "AutoWebP",
        },
        "CloudFrontPriceClassParameter": {
          "default": "CloudFront PriceClass",
        },
        "CorsEnabledParameter": {
          "default": "CORS Enabled",
        },
        "CorsOriginParameter": {
          "default": "CORS Origin",
        },
        "DeployDemoUIParameter": {
          "default": "Deploy Demo UI",
        },
        "EnableDefaultFallbackImageParameter": {
          "default": "Enable Default Fallback Image",
        },
        "EnableSignatureParameter": {
          "default": "Enable Signature",
        },
        "FallbackImageS3BucketParameter": {
          "default": "Fallback Image S3 Bucket",
        },
        "FallbackImageS3KeyParameter": {
          "default": "Fallback Image S3 Key",
        },
        "LogRetentionPeriodParameter": {
          "default": "Log Retention Period",
        },
        "SecretsManagerKeyParameter": {
          "default": "SecretsManager Key",
        },
        "SecretsManagerSecretParameter": {
          "default": "SecretsManager Secret",
        },
        "SourceBucketsParameter": {
          "default": "Source Buckets",
        },
      },
    },
  },
  "Outputs": {
    "ApiEndpoint": {
      "Description": "Link to API endpoint for sending image requests to.",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://",
            {
              "Fn::GetAtt": [
                "BackEndImageHandlerCloudFrontApiGatewayLambdaCloudFrontToApiGatewayCloudFrontDistribution03AA31B2",
                "DomainName",
              ],
            },
          ],
        ],
      },
    },
    "CorsEnabled": {
      "Description": "Indicates whether Cross-Origin Resource Sharing (CORS) has been enabled for the image handler API.",
      "Value": {
        "Ref": "CorsEnabledParameter",
      },
    },
    "CorsOrigin": {
      "Condition": "CommonResourcesEnableCorsConditionA0615348",
      "Description": "Origin value returned in the Access-Control-Allow-Origin header of image handler API responses.",
      "Value": {
        "Ref": "CorsOriginParameter",
      },
    },
    "DemoUrl": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Description": "Link to the demo user interface for the solution.",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://",
            {
              "Fn::GetAtt": [
                "FrontEndDistributionToS3CloudFrontDistribution15FE13D0",
                "DomainName",
              ],
            },
            "/index.html",
          ],
        ],
      },
    },
    "LogRetentionPeriod": {
      "Description": "Number of days for event logs from Lambda to be retained in CloudWatch.",
      "Value": {
        "Ref": "LogRetentionPeriodParameter",
      },
    },
    "SourceBuckets": {
      "Description": "Amazon S3 bucket location containing original image files.",
      "Value": {
        "Ref": "SourceBucketsParameter",
      },
    },
  },
  "Parameters": {
    "AutoWebPParameter": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Would you like to enable automatic WebP based on accept headers? Select 'Yes' if so.",
      "Type": "String",
    },
    "BootstrapVersion": {
      "Default": "/cdk-bootstrap/hnb659fds/version",
      "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]",
      "Type": "AWS::SSM::Parameter::Value<String>",
    },
    "CloudFrontPriceClassParameter": {
      "AllowedValues": [
        "PriceClass_All",
        "PriceClass_200",
        "PriceClass_100",
      ],
      "Default": "PriceClass_All",
      "Description": "The AWS CloudFront price class to use. For more information see: https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/PriceClass.html",
      "Type": "String",
    },
    "CorsEnabledParameter": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Would you like to enable Cross-Origin Resource Sharing (CORS) for the image handler API? Select 'Yes' if so.",
      "Type": "String",
    },
    "CorsOriginParameter": {
      "Default": "*",
      "Description": "If you selected 'Yes' above, please specify an origin value here. A wildcard (*) value will support any origin. We recommend specifying an origin (i.e. https://example.domain) to restrict cross-site access to your API.",
      "Type": "String",
    },
    "DeployDemoUIParameter": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "Yes",
      "Description": "Would you like to deploy a demo UI to explore the features and capabilities of this solution? This will create an additional Amazon S3 bucket and Amazon CloudFront distribution in your account.",
      "Type": "String",
    },
    "EnableDefaultFallbackImageParameter": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Would you like to enable the default fallback image? If so, select 'Yes' and provide FallbackImageS3Bucket and FallbackImageS3Key values.",
      "Type": "String",
    },
    "EnableSignatureParameter": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Would you like to enable the signature? If so, select 'Yes' and provide SecretsManagerSecret and SecretsManagerKey values.",
      "Type": "String",
    },
    "FallbackImageS3BucketParameter": {
      "Default": "",
      "Description": "The name of the Amazon S3 bucket which contains the default fallback image. e.g. my-fallback-image-bucket",
      "Type": "String",
    },
    "FallbackImageS3KeyParameter": {
      "Default": "",
      "Description": "The name of the default fallback image object key including prefix. e.g. prefix/image.jpg",
      "Type": "String",
    },
    "LogRetentionPeriodParameter": {
      "AllowedValues": [
        "1",
        "3",
        "5",
        "7",
        "14",
        "30",
        "60",
        "90",
        "120",
        "150",
        "180",
        "365",
        "400",
        "545",
        "731",
        "1827",
        "3653",
      ],
      "Default": "1",
      "Description": "This solution automatically logs events to Amazon CloudWatch. Select the amount of time for CloudWatch logs from this solution to be retained (in days).",
      "Type": "Number",
    },
    "SecretsManagerKeyParameter": {
      "Default": "",
      "Description": "The name of AWS Secrets Manager secret key. You need to create secret key with this key name. The secret value would be used to check signature.",
      "Type": "String",
    },
    "SecretsManagerSecretParameter": {
      "Default": "",
      "Description": "The name of AWS Secrets Manager secret. You need to create your secret under this name.",
      "Type": "String",
    },
    "SourceBucketsParameter": {
      "AllowedPattern": ".+",
      "Default": "defaultBucket, bucketNo2, bucketNo3, ...",
      "Description": "(Required) List the buckets (comma-separated) within your account that contain original image files. If you plan to use Thumbor or Custom image requests with this solution, the source bucket for those requests will be the first bucket listed in this field.",
      "Type": "String",
    },
  },
  "Resources": {
    "AppRegistry968496A3": {
      "Properties": {
        "Description": "Service Catalog application to track and manage all your resources for the solution sih",
        "Name": {
          "Fn::Join": [
            "-",
            [
              "AppRegistry",
              {
                "Ref": "AWS::StackName",
              },
              {
                "Ref": "AWS::Region",
              },
              {
                "Ref": "AWS::AccountId",
              },
            ],
          ],
        },
        "Tags": {
          "SolutionId": "S0ABC",
          "Solutions:ApplicationType": "AWS-Solutions",
          "Solutions:SolutionID": "S0ABC",
          "Solutions:SolutionName": "sih",
          "Solutions:SolutionVersion": "v6.2.5",
        },
      },
      "Type": "AWS::ServiceCatalogAppRegistry::Application",
    },
    "AppRegistryAssociation": {
      "Properties": {
        "Application": {
          "Fn::GetAtt": [
            "AppRegistry968496A3",
            "Id",
          ],
        },
        "Resource": {
          "Ref": "AWS::StackId",
        },
        "ResourceType": "CFN_STACK",
      },
      "Type": "AWS::ServiceCatalogAppRegistry::ResourceAssociation",
    },
    "BackEndCachePolicy1DCE9B1B": {
      "Properties": {
        "CachePolicyConfig": {
          "DefaultTTL": 86400,
          "MaxTTL": 31536000,
          "MinTTL": 1,
          "Name": {
            "Fn::Join": [
              "",
              [
                "ServerlessImageHandler-",
                {
                  "Fn::GetAtt": [
                    "CommonResourcesCustomResourcesCustomResourceUuid64E7CCAD",
                    "UUID",
                  ],
                },
              ],
            ],
          },
          "ParametersInCacheKeyAndForwardedToOrigin": {
            "CookiesConfig": {
              "CookieBehavior": "none",
            },
            "EnableAcceptEncodingBrotli": false,
            "EnableAcceptEncodingGzip": false,
            "HeadersConfig": {
              "HeaderBehavior": "whitelist",
              "Headers": [
                "origin",
                "accept",
              ],
            },
            "QueryStringsConfig": {
              "QueryStringBehavior": "whitelist",
              "QueryStrings": [
                "signature",
                "edits",
                "headers",
                "effort",
                "outputFormat",
              ],
            },
          },
        },
      },
      "Type": "AWS::CloudFront::CachePolicy",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaApiAccessLogGroup9B786692": {
      "DeletionPolicy": "Retain",
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W84",
              "reason": "By default CloudWatchLogs LogGroups data is encrypted using the CloudWatch server-side encryption keys (AWS Managed Keys)",
            },
          ],
        },
      },
      "Properties": {
        "RetentionInDays": {
          "Ref": "LogRetentionPeriodParameter",
        },
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::Logs::LogGroup",
      "UpdateReplacePolicy": "Retain",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaCloudFrontToApiGatewayCloudFrontDistribution03AA31B2": {
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W70",
              "reason": "Since the distribution uses the CloudFront domain name, CloudFront automatically sets the security policy to TLSv1 regardless of the value of MinimumProtocolVersion",
            },
          ],
        },
      },
      "Properties": {
        "DistributionConfig": {
          "Comment": "Image Handler Distribution for Serverless Image Handler",
          "CustomErrorResponses": [
            {
              "ErrorCachingMinTTL": 600,
              "ErrorCode": 500,
            },
            {
              "ErrorCachingMinTTL": 600,
              "ErrorCode": 501,
            },
            {
              "ErrorCachingMinTTL": 600,
              "ErrorCode": 502,
            },
            {
              "ErrorCachingMinTTL": 600,
              "ErrorCode": 503,
            },
            {
              "ErrorCachingMinTTL": 600,
              "ErrorCode": 504,
            },
          ],
          "DefaultCacheBehavior": {
            "AllowedMethods": [
              "GET",
              "HEAD",
            ],
            "CachePolicyId": {
              "Ref": "BackEndCachePolicy1DCE9B1B",
            },
            "Compress": true,
            "FunctionAssociations": [
              {
                "EventType": "viewer-request",
                "FunctionARN": {
                  "Fn::GetAtt": [
                    "BackEndNormalizeAcceptHeaderFunctionA8503110",
                    "FunctionARN",
                  ],
                },
              },
            ],
            "OriginRequestPolicyId": {
              "Ref": "BackEndOriginRequestPolicy771345D7",
            },
            "TargetOriginId": "TestStack4BackEndImageHandlerCloudFrontApiGatewayLambdaCloudFrontToApiGatewayCloudFrontDistributionOrigin102B8126F",
            "ViewerProtocolPolicy": "https-only",
          },
          "Enabled": true,
          "HttpVersion": "http2",
          "IPV6Enabled": true,
          "Logging": {
            "Bucket": {
              "Fn::Join": [
                "",
                [
                  {
                    "Fn::GetAtt": [
                      "CommonResourcesCustomResourcesLogBucketCustomResource2445A3AB",
                      "BucketName",
                    ],
                  },
                  ".s3.",
                  {
                    "Fn::GetAtt": [
                      "CommonResourcesCustomResourcesLogBucketCustomResource2445A3AB",
                      "Region",
                    ],
                  },
                  ".",
                  {
                    "Ref": "AWS::URLSuffix",
                  },
                ],
              ],
            },
            "Prefix": "api-cloudfront/",
          },
          "Origins": [
            {
              "CustomOriginConfig": {
                "OriginProtocolPolicy": "https-only",
                "OriginSSLProtocols": [
                  "TLSv1.1",
                  "TLSv1.2",
                ],
              },
              "DomainName": {
                "Fn::Join": [
                  "",
                  [
                    {
                      "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
                    },
                    ".execute-api.",
                    {
                      "Ref": "AWS::Region",
                    },
                    ".amazonaws.com",
                  ],
                ],
              },
              "Id": "TestStack4BackEndImageHandlerCloudFrontApiGatewayLambdaCloudFrontToApiGatewayCloudFrontDistributionOrigin102B8126F",
              "OriginPath": "/image",
              "OriginShield": {
                "Enabled": true,
              },
            },
          ],
          "PriceClass": {
            "Ref": "CloudFrontPriceClassParameter",
          },
        },
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::CloudFront::Distribution",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109": {
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W59",
              "reason": "AWS::ApiGateway::Method AuthorizationType is set to 'NONE' because API Gateway behind CloudFront does not support AWS_IAM authentication",
            },
          ],
        },
      },
      "Properties": {
        "BinaryMediaTypes": [
          "*/*",
        ],
        "EndpointConfiguration": {
          "Types": [
            "REGIONAL",
          ],
        },
        "Name": "LambdaRestApi",
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::ApiGateway::RestApi",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiANYApiPermissionTestStack4BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi1CBCAAABANYAC9359AD": {
      "Properties": {
        "Action": "lambda:InvokeFunction",
        "FunctionName": {
          "Fn::GetAtt": [
            "BackEndImageHandlerLambdaFunctionADEF7FF2",
            "Arn",
          ],
        },
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": {
          "Fn::Join": [
            "",
            [
              "arn:",
              {
                "Ref": "AWS::Partition",
              },
              ":execute-api:",
              {
                "Ref": "AWS::Region",
              },
              ":",
              {
                "Ref": "AWS::AccountId",
              },
              ":",
              {
                "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
              },
              "/",
              {
                "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiDeploymentStageimageB55D20E3",
              },
              "/*/",
            ],
          ],
        },
      },
      "Type": "AWS::Lambda::Permission",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiANYApiPermissionTestTestStack4BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi1CBCAAABANY615FA7E1": {
      "Properties": {
        "Action": "lambda:InvokeFunction",
        "FunctionName": {
          "Fn::GetAtt": [
            "BackEndImageHandlerLambdaFunctionADEF7FF2",
            "Arn",
          ],
        },
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": {
          "Fn::Join": [
            "",
            [
              "arn:",
              {
                "Ref": "AWS::Partition",
              },
              ":execute-api:",
              {
                "Ref": "AWS::Region",
              },
              ":",
              {
                "Ref": "AWS::AccountId",
              },
              ":",
              {
                "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
              },
              "/test-invoke-stage/*/",
            ],
          ],
        },
      },
      "Type": "AWS::Lambda::Permission",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiANYE4494B31": {
      "Properties": {
        "AuthorizationType": "NONE",
        "HttpMethod": "ANY",
        "Integration": {
          "IntegrationHttpMethod": "POST",
          "Type": "AWS_PROXY",
          "Uri": {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":apigateway:",
                {
                  "Ref": "AWS::Region",
                },
                ":lambda:path/2015-03-31/functions/",
                {
                  "Fn::GetAtt": [
                    "BackEndImageHandlerLambdaFunctionADEF7FF2",
                    "Arn",
                  ],
                },
                "/invocations",
              ],
            ],
          },
        },
        "ResourceId": {
          "Fn::GetAtt": [
            "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
            "RootResourceId",
          ],
        },
        "RestApiId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
        },
      },
      "Type": "AWS::ApiGateway::Method",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiAccountE5522E5D": {
      "DependsOn": [
        "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
      ],
      "Properties": {
        "CloudWatchRoleArn": {
          "Fn::GetAtt": [
            "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiCloudWatchRole12575C4D",
            "Arn",
          ],
        },
      },
      "Type": "AWS::ApiGateway::Account",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiCloudWatchRole12575C4D": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "apigateway.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "Policies": [
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:DescribeLogGroups",
                    "logs:DescribeLogStreams",
                    "logs:PutLogEvents",
                    "logs:GetLogEvents",
                    "logs:FilterLogEvents",
                  ],
                  "Effect": "Allow",
                  "Resource": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:",
                        {
                          "Ref": "AWS::Partition",
                        },
                        ":logs:",
                        {
                          "Ref": "AWS::Region",
                        },
                        ":",
                        {
                          "Ref": "AWS::AccountId",
                        },
                        ":*",
                      ],
                    ],
                  },
                },
              ],
              "Version": "2012-10-17",
            },
            "PolicyName": "LambdaRestApiCloudWatchRolePolicy",
          },
        ],
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiDeployment663240D6bb2931f4d7f47b51b7b40b3fd0d7001b": {
      "DependsOn": [
        "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyANY8F9763E1",
        "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyBDF0A131",
        "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiANYE4494B31",
      ],
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W45",
              "reason": "ApiGateway has AccessLogging enabled in AWS::ApiGateway::Stage resource, but cfn_nag checks for it in AWS::ApiGateway::Deployment resource",
            },
          ],
        },
      },
      "Properties": {
        "Description": "Automatically created by the RestApi construct",
        "RestApiId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
        },
      },
      "Type": "AWS::ApiGateway::Deployment",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiDeploymentStageimageB55D20E3": {
      "Properties": {
        "AccessLogSetting": {
          "DestinationArn": {
            "Fn::GetAtt": [
              "BackEndImageHandlerCloudFrontApiGatewayLambdaApiAccessLogGroup9B786692",
              "Arn",
            ],
          },
          "Format": "{"requestId":"$context.requestId","ip":"$context.identity.sourceIp","user":"$context.identity.user","caller":"$context.identity.caller","requestTime":"$context.requestTime","httpMethod":"$context.httpMethod","resourcePath":"$context.resourcePath","status":"$context.status","protocol":"$context.protocol","responseLength":"$context.responseLength"}",
        },
        "DeploymentId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiDeployment663240D6bb2931f4d7f47b51b7b40b3fd0d7001b",
        },
        "MethodSettings": [
          {
            "DataTraceEnabled": false,
            "HttpMethod": "*",
            "LoggingLevel": "INFO",
            "ResourcePath": "/*",
          },
        ],
        "RestApiId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
        },
        "StageName": "image",
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
        "TracingEnabled": true,
      },
      "Type": "AWS::ApiGateway::Stage",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiUsagePlan76CA1E70": {
      "Properties": {
        "ApiStages": [
          {
            "ApiId": {
              "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
            },
            "Stage": {
              "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiDeploymentStageimageB55D20E3",
            },
            "Throttle": {},
          },
        ],
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::ApiGateway::UsagePlan",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyANY8F9763E1": {
      "Properties": {
        "AuthorizationType": "NONE",
        "HttpMethod": "ANY",
        "Integration": {
          "IntegrationHttpMethod": "POST",
          "Type": "AWS_PROXY",
          "Uri": {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":apigateway:",
                {
                  "Ref": "AWS::Region",
                },
                ":lambda:path/2015-03-31/functions/",
                {
                  "Fn::GetAtt": [
                    "BackEndImageHandlerLambdaFunctionADEF7FF2",
                    "Arn",
                  ],
                },
                "/invocations",
              ],
            ],
          },
        },
        "ResourceId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyBDF0A131",
        },
        "RestApiId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
        },
      },
      "Type": "AWS::ApiGateway::Method",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyANYApiPermissionTestStack4BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi1CBCAAABANYproxyBB008F23": {
      "Properties": {
        "Action": "lambda:InvokeFunction",
        "FunctionName": {
          "Fn::GetAtt": [
            "BackEndImageHandlerLambdaFunctionADEF7FF2",
            "Arn",
          ],
        },
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": {
          "Fn::Join": [
            "",
            [
              "arn:",
              {
                "Ref": "AWS::Partition",
              },
              ":execute-api:",
              {
                "Ref": "AWS::Region",
              },
              ":",
              {
                "Ref": "AWS::AccountId",
              },
              ":",
              {
                "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
              },
              "/",
              {
                "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiDeploymentStageimageB55D20E3",
              },
              "/*/*",
            ],
          ],
        },
      },
      "Type": "AWS::Lambda::Permission",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyANYApiPermissionTestTestStack4BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi1CBCAAABANYproxy45D18737": {
      "Properties": {
        "Action": "lambda:InvokeFunction",
        "FunctionName": {
          "Fn::GetAtt": [
            "BackEndImageHandlerLambdaFunctionADEF7FF2",
            "Arn",
          ],
        },
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": {
          "Fn::Join": [
            "",
            [
              "arn:",
              {
                "Ref": "AWS::Partition",
              },
              ":execute-api:",
              {
                "Ref": "AWS::Region",
              },
              ":",
              {
                "Ref": "AWS::AccountId",
              },
              ":",
              {
                "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
              },
              "/test-invoke-stage/*/*",
            ],
          ],
        },
      },
      "Type": "AWS::Lambda::Permission",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyBDF0A131": {
      "Properties": {
        "ParentId": {
          "Fn::GetAtt": [
            "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
            "RootResourceId",
          ],
        },
        "PathPart": "{proxy+}",
        "RestApiId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
        },
      },
      "Type": "AWS::ApiGateway::Resource",
    },
    "BackEndImageHandlerFunctionPolicy437940B5": {
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W12",
              "reason": "rekognition:DetectFaces requires '*' resources.",
            },
          ],
        },
      },
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents",
              ],
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition",
                    },
                    ":logs:",
                    {
                      "Ref": "AWS::Region",
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    ":log-group:/aws/lambda/*",
                  ],
                ],
              },
            },
            {
              "Action": [
                "s3:GetObject",
                "s3:PutObject",
                "s3:ListBucket",
              ],
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition",
                    },
                    ":s3:::*",
                  ],
                ],
              },
            },
            {
              "Action": [
                "rekognition:DetectFaces",
                "rekognition:DetectModerationLabels",
              ],
              "Effect": "Allow",
              "Resource": "*",
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "BackEndImageHandlerFunctionPolicy437940B5",
        "Roles": [
          {
            "Ref": "BackEndImageHandlerFunctionRoleABF81E5C",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "BackEndImageHandlerFunctionRoleABF81E5C": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "BackEndImageHandlerLambdaFunctionADEF7FF2": {
      "DependsOn": [
        "BackEndImageHandlerFunctionRoleABF81E5C",
      ],
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W58",
              "reason": "The function does have permission to write CloudWatch Logs.",
            },
            {
              "id": "W89",
              "reason": "The Lambda function does not require any VPC connection at all.",
            },
            {
              "id": "W92",
              "reason": "The Lambda function does not require ReservedConcurrentExecutions.",
            },
          ],
        },
      },
      "Properties": {
        "Code": {
          "S3Bucket": {
            "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-\${AWS::Region}",
          },
          "S3Key": "Omitted to remove snapshot dependency on hash",
        },
        "Description": "sih (v6.2.5): Performs image edits and manipulations",
        "Environment": {
          "Variables": {
            "AUTO_WEBP": {
              "Ref": "AutoWebPParameter",
            },
            "AWS_NODEJS_CONNECTION_REUSE_ENABLED": "1",
            "CORS_ENABLED": {
              "Ref": "CorsEnabledParameter",
            },
            "CORS_ORIGIN": {
              "Ref": "CorsOriginParameter",
            },
            "DEFAULT_FALLBACK_IMAGE_BUCKET": {
              "Ref": "FallbackImageS3BucketParameter",
            },
            "DEFAULT_FALLBACK_IMAGE_KEY": {
              "Ref": "FallbackImageS3KeyParameter",
            },
            "ENABLE_DEFAULT_FALLBACK_IMAGE": {
              "Ref": "EnableDefaultFallbackImageParameter",
            },
            "ENABLE_SIGNATURE": {
              "Ref": "EnableSignatureParameter",
            },
            "REWRITE_MATCH_PATTERN": "",
            "REWRITE_SUBSTITUTION": "",
            "SECRETS_MANAGER": {
              "Ref": "SecretsManagerSecretParameter",
            },
            "SECRET_KEY": {
              "Ref": "SecretsManagerKeyParameter",
            },
            "SOURCE_BUCKETS": {
              "Ref": "SourceBucketsParameter",
            },
          },
        },
        "Handler": "index.handler",
        "MemorySize": 1024,
        "Role": {
          "Fn::GetAtt": [
            "BackEndImageHandlerFunctionRoleABF81E5C",
            "Arn",
          ],
        },
        "Runtime": "nodejs20.x",
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
        "Timeout": 29,
      },
      "Type": "AWS::Lambda::Function",
    },
    "BackEndImageHandlerLogGroupA0941EEC": {
      "DeletionPolicy": "Retain",
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W84",
              "reason": "CloudWatch log group is always encrypted by default.",
            },
          ],
        },
      },
      "Properties": {
        "LogGroupName": {
          "Fn::Join": [
            "",
            [
              "/aws/lambda/",
              {
                "Ref": "BackEndImageHandlerLambdaFunctionADEF7FF2",
              },
            ],
          ],
        },
        "RetentionInDays": {
          "Ref": "LogRetentionPeriodParameter",
        },
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::Logs::LogGroup",
      "UpdateReplacePolicy": "Retain",
    },
    "BackEndNormalizeAcceptHeaderFunctionA8503110": {
      "Properties": {
        "AutoPublish": true,
        "FunctionCode": "
function handler(event) {
  if (event.request.headers && event.request.headers.accept && event.request.headers.accept.value) {
    let resultingHeader = "image/jpg";
    const acceptheadervalue = event.request.headers.accept.value;
    if (acceptheadervalue.includes("image/webp")) {
      resultingHeader = "image/webp";
    }
    event.request.headers.accept = { value: resultingHeader };
  }
  return event.request;
}
",
        "FunctionConfig": {
          "Comment": {
            "Fn::Join": [
              "",
              [
                "normalize-accept-headers-",
                {
                  "Ref": "AWS::Region",
                },
              ],
            ],
          },
          "Runtime": "cloudfront-js-1.0",
        },
        "Name": {
          "Fn::Join": [
            "",
            [
              "normalize-accept-headers-",
              {
                "Ref": "AWS::Region",
              },
            ],
          ],
        },
      },
      "Type": "AWS::CloudFront::Function",
    },
    "BackEndOriginRequestPolicy771345D7": {
      "Properties": {
        "OriginRequestPolicyConfig": {
          "CookiesConfig": {
            "CookieBehavior": "none",
          },
          "HeadersConfig": {
            "HeaderBehavior": "whitelist",
            "Headers": [
              "origin",
              "accept",
            ],
          },
          "Name": {
            "Fn::Join": [
              "",
              [
                "ServerlessImageHandler-",
                {
                  "Fn::GetAtt": [
                    "CommonResourcesCustomResourcesCustomResourceUuid64E7CCAD",
                    "UUID",
                  ],
                },
              ],
            ],
          },
          "QueryStringsConfig": {
            "QueryStringBehavior": "whitelist",
            "QueryStrings": [
              "signature",
              "edits",
              "headers",
              "effort",
              "outputFormat",
            ],
          },
        },
      },
      "Type": "AWS::CloudFront::OriginRequestPolicy",
    },
    "CommonResourcesCustomResourcesCustomResourceAnonymousMetric51363F57": {
      "DeletionPolicy": "Delete",
      "Properties": {
        "AnonymousData": "No",
        "AutoWebP": {
          "Ref": "AutoWebPParameter",
        },
        "CorsEnabled": {
          "Ref": "CorsEnabledParameter",
        },
        "CustomAction": "sendMetric",
        "DeployDemoUi": {
          "Ref": "DeployDemoUIParameter",
        },
        "EnableDefaultFallbackImage": {
          "Ref": "EnableDefaultFallbackImageParameter",
        },
        "EnableSignature": {
          "Ref": "EnableSignatureParameter",
        },
        "LogRetentionPeriod": {
          "Ref": "LogRetentionPeriodParameter",
        },
        "Region": {
          "Ref": "AWS::Region",
        },
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
        "SourceBuckets": {
          "Ref": "SourceBucketsParameter",
        },
        "UUID": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceUuid64E7CCAD",
            "UUID",
          ],
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesCustomResourceCheckFallbackImage6CE45571": {
      "Condition": "CommonResourcesEnableDefaultFallbackImageConditionD1A10983",
      "DeletionPolicy": "Delete",
      "Properties": {
        "CustomAction": "checkFallbackImage",
        "FallbackImageS3Bucket": {
          "Ref": "FallbackImageS3BucketParameter",
        },
        "FallbackImageS3Key": {
          "Ref": "FallbackImageS3KeyParameter",
        },
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesCustomResourceCheckSecretsManagerAEEEC776": {
      "Condition": "CommonResourcesEnableSignatureCondition909DC7A1",
      "DeletionPolicy": "Delete",
      "Properties": {
        "CustomAction": "checkSecretsManager",
        "SecretsManagerKey": {
          "Ref": "SecretsManagerKeyParameter",
        },
        "SecretsManagerName": {
          "Ref": "SecretsManagerSecretParameter",
        },
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesCustomResourceCheckSourceBucketsA313C9B7": {
      "DeletionPolicy": "Delete",
      "Properties": {
        "CustomAction": "checkSourceBuckets",
        "Region": {
          "Ref": "AWS::Region",
        },
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
        "SourceBuckets": {
          "Ref": "SourceBucketsParameter",
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesCustomResourceFunction0D924235": {
      "DependsOn": [
        "CommonResourcesCustomResourcesCustomResourceRole8958A1ED",
      ],
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W58",
              "reason": "The function does have permission to write CloudWatch Logs.",
            },
            {
              "id": "W89",
              "reason": "The Lambda function does not require any VPC connection at all.",
            },
            {
              "id": "W92",
              "reason": "The Lambda function does not require ReservedConcurrentExecutions.",
            },
          ],
        },
      },
      "Properties": {
        "Code": {
          "S3Bucket": {
            "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-\${AWS::Region}",
          },
          "S3Key": "Omitted to remove snapshot dependency on hash",
        },
        "Description": "sih (v6.2.5): Custom resource",
        "Environment": {
          "Variables": {
            "AWS_NODEJS_CONNECTION_REUSE_ENABLED": "1",
            "RETRY_SECONDS": "5",
            "SOLUTION_ID": "S0ABC",
            "SOLUTION_VERSION": "v6.2.5",
          },
        },
        "Handler": "index.handler",
        "MemorySize": 128,
        "Role": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceRole8958A1ED",
            "Arn",
          ],
        },
        "Runtime": "nodejs20.x",
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
        "Timeout": 60,
      },
      "Type": "AWS::Lambda::Function",
    },
    "CommonResourcesCustomResourcesCustomResourceRole8958A1ED": {
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W11",
              "reason": "Allow '*' because it is required for making DescribeRegions API call as it doesn't support resource-level permissions and require to choose all resources.",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "Path": "/",
        "Policies": [
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents",
                  ],
                  "Effect": "Allow",
                  "Resource": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:",
                        {
                          "Ref": "AWS::Partition",
                        },
                        ":logs:",
                        {
                          "Ref": "AWS::Region",
                        },
                        ":",
                        {
                          "Ref": "AWS::AccountId",
                        },
                        ":log-group:/aws/lambda/*",
                      ],
                    ],
                  },
                },
                {
                  "Action": [
                    "s3:putBucketAcl",
                    "s3:putEncryptionConfiguration",
                    "s3:putBucketPolicy",
                    "s3:CreateBucket",
                    "s3:GetObject",
                    "s3:PutObject",
                    "s3:ListBucket",
                    "s3:PutBucketOwnershipControls",
                  ],
                  "Effect": "Allow",
                  "Resource": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:",
                        {
                          "Ref": "AWS::Partition",
                        },
                        ":s3:::*",
                      ],
                    ],
                  },
                },
              ],
              "Version": "2012-10-17",
            },
            "PolicyName": "CloudWatchLogsPolicy",
          },
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": "ec2:DescribeRegions",
                  "Effect": "Allow",
                  "Resource": "*",
                },
              ],
              "Version": "2012-10-17",
            },
            "PolicyName": "EC2Policy",
          },
        ],
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "CommonResourcesCustomResourcesCustomResourceUuid64E7CCAD": {
      "DeletionPolicy": "Delete",
      "Properties": {
        "CustomAction": "createUuid",
        "Region": {
          "Ref": "AWS::Region",
        },
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesDeployWebsiteAwsCliLayerBC025F39": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Properties": {
        "Content": {
          "S3Bucket": {
            "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-\${AWS::Region}",
          },
          "S3Key": "Omitted to remove snapshot dependency on hash",
        },
        "Description": "/opt/awscli/aws",
      },
      "Type": "AWS::Lambda::LayerVersion",
    },
    "CommonResourcesCustomResourcesDeployWebsiteCustomResourceECB9B136": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "DeletionPolicy": "Delete",
      "Properties": {
        "DestinationBucketName": {
          "Ref": "FrontEndDistributionToS3S3Bucket3A171D78",
        },
        "Exclude": [
          "demo-ui-config.js",
        ],
        "Prune": true,
        "ServiceToken": {
          "Fn::GetAtt": [
            "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756C81C01536",
            "Arn",
          ],
        },
        "SourceBucketNames": [
          {
            "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-\${AWS::Region}",
          },
        ],
        "SourceObjectKeys": [
          "c301c2cce52bb1b36720a115d657907f3ec9fa20bd385b4d81bf451fbe77fe4b.zip",
        ],
      },
      "Type": "Custom::CDKBucketDeployment",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesLogBucketCustomResource2445A3AB": {
      "DeletionPolicy": "Delete",
      "Properties": {
        "BucketSuffix": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AWS::StackName",
              },
              "-",
              {
                "Ref": "AWS::Region",
              },
              "-",
              {
                "Ref": "AWS::AccountId",
              },
            ],
          ],
        },
        "CustomAction": "createCloudFrontLoggingBucket",
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesPutWebsiteConfigC4E435F3": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "DeletionPolicy": "Delete",
      "Properties": {
        "ConfigItem": {
          "apiEndpoint": {
            "Fn::Join": [
              "",
              [
                "https://",
                {
                  "Fn::GetAtt": [
                    "BackEndImageHandlerCloudFrontApiGatewayLambdaCloudFrontToApiGatewayCloudFrontDistribution03AA31B2",
                    "DomainName",
                  ],
                },
              ],
            ],
          },
        },
        "CustomAction": "putConfigFile",
        "DestS3Bucket": {
          "Ref": "FrontEndDistributionToS3S3Bucket3A171D78",
        },
        "DestS3key": "demo-ui-config.js",
        "Region": {
          "Ref": "AWS::Region",
        },
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesSecretsManagerPolicy45FE005E": {
      "Condition": "CommonResourcesEnableSignatureCondition909DC7A1",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "secretsmanager:GetSecretValue",
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition",
                    },
                    ":secretsmanager:",
                    {
                      "Ref": "AWS::Region",
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    ":secret:",
                    {
                      "Ref": "SecretsManagerSecretParameter",
                    },
                    "*",
                  ],
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "CommonResourcesSecretsManagerPolicy45FE005E",
        "Roles": [
          {
            "Ref": "CommonResourcesCustomResourcesCustomResourceRole8958A1ED",
          },
          {
            "Ref": "BackEndImageHandlerFunctionRoleABF81E5C",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756C81C01536": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "DependsOn": [
        "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRoleDefaultPolicy88902FDF",
        "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRole89A01265",
      ],
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W58",
              "reason": "The function does have permission to write CloudWatch Logs.",
            },
            {
              "id": "W89",
              "reason": "The Lambda function does not require any VPC connection at all.",
            },
            {
              "id": "W92",
              "reason": "The Lambda function does not require ReservedConcurrentExecutions.",
            },
          ],
        },
      },
      "Properties": {
        "Code": {
          "S3Bucket": {
            "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-\${AWS::Region}",
          },
          "S3Key": "Omitted to remove snapshot dependency on hash",
        },
        "Environment": {
          "Variables": {
            "AWS_CA_BUNDLE": "/etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem",
          },
        },
        "Handler": "index.handler",
        "Layers": [
          {
            "Ref": "CommonResourcesCustomResourcesDeployWebsiteAwsCliLayerBC025F39",
          },
        ],
        "Role": {
          "Fn::GetAtt": [
            "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRole89A01265",
            "Arn",
          ],
        },
        "Runtime": "python3.9",
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
        "Timeout": 900,
      },
      "Type": "AWS::Lambda::Function",
    },
    "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRole89A01265": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
        ],
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRoleDefaultPolicy88902FDF": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "s3:GetObject*",
                "s3:GetBucket*",
                "s3:List*",
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-\${AWS::Region}",
                      },
                    ],
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-\${AWS::Region}",
                      },
                      "/*",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": [
                "s3:GetObject*",
                "s3:GetBucket*",
                "s3:List*",
                "s3:DeleteObject*",
                "s3:PutObject",
                "s3:PutObjectLegalHold",
                "s3:PutObjectRetention",
                "s3:PutObjectTagging",
                "s3:PutObjectVersionTagging",
                "s3:Abort*",
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "FrontEndDistributionToS3S3Bucket3A171D78",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "FrontEndDistributionToS3S3Bucket3A171D78",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRoleDefaultPolicy88902FDF",
        "Roles": [
          {
            "Ref": "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRole89A01265",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "DefaultApplicationAttributeGroup41AD7209": {
      "Properties": {
        "Attributes": {
          "applicationType": "AWS-Solutions",
          "solutionID": "S0ABC",
          "solutionName": "sih",
          "version": "v6.2.5",
        },
        "Description": "Attribute group for solution information",
        "Name": {
          "Fn::Join": [
            "",
            [
              "A30-AppRegistry-",
              {
                "Ref": "AWS::StackName",
              },
            ],
          ],
        },
        "Tags": {
          "SolutionId": "S0ABC",
        },
      },
      "Type": "AWS::ServiceCatalogAppRegistry::AttributeGroup",
    },
    "DefaultApplicationAttributeGroupApplicationAttributeGroupAssociationcb8a1f34b719CD3BA034": {
      "Properties": {
        "Application": {
          "Fn::GetAtt": [
            "AppRegistry968496A3",
            "Id",
          ],
        },
        "AttributeGroup": {
          "Fn::GetAtt": [
            "DefaultApplicationAttributeGroup41AD7209",
            "Id",
          ],
        },
      },
      "Type": "AWS::ServiceCatalogAppRegistry::AttributeGroupAssociation",
    },
    "FrontEndDistributionToS3CloudFrontDistribution15FE13D0": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W70",
              "reason": "Since the distribution uses the CloudFront domain name, CloudFront automatically sets the security policy to TLSv1 regardless of the value of MinimumProtocolVersion",
            },
          ],
        },
      },
      "Properties": {
        "DistributionConfig": {
          "Comment": "Demo UI Distribution for Serverless Image Handler",
          "CustomErrorResponses": [
            {
              "ErrorCode": 403,
              "ResponseCode": 200,
              "ResponsePagePath": "/index.html",
            },
            {
              "ErrorCode": 404,
              "ResponseCode": 200,
              "ResponsePagePath": "/index.html",
            },
          ],
          "DefaultCacheBehavior": {
            "CachePolicyId": "658327ea-f89d-4fab-a63d-7e88639e58f6",
            "Compress": true,
            "TargetOriginId": "TestStack4FrontEndDistributionToS3CloudFrontDistributionOrigin14F3E9ADA",
            "ViewerProtocolPolicy": "redirect-to-https",
          },
          "DefaultRootObject": "index.html",
          "Enabled": true,
          "HttpVersion": "http2",
          "IPV6Enabled": true,
          "Logging": {
            "Bucket": {
              "Fn::Join": [
                "",
                [
                  {
                    "Fn::GetAtt": [
                      "CommonResourcesCustomResourcesLogBucketCustomResource2445A3AB",
                      "BucketName",
                    ],
                  },
                  ".s3.",
                  {
                    "Fn::GetAtt": [
                      "CommonResourcesCustomResourcesLogBucketCustomResource2445A3AB",
                      "Region",
                    ],
                  },
                  ".",
                  {
                    "Ref": "AWS::URLSuffix",
                  },
                ],
              ],
            },
            "Prefix": "ui-cloudfront/",
          },
          "Origins": [
            {
              "DomainName": {
                "Fn::GetAtt": [
                  "FrontEndDistributionToS3S3Bucket3A171D78",
                  "RegionalDomainName",
                ],
              },
              "Id": "TestStack4FrontEndDistributionToS3CloudFrontDistributionOrigin14F3E9ADA",
              "S3OriginConfig": {
                "OriginAccessIdentity": {
                  "Fn::Join": [
                    "",
                    [
                      "origin-access-identity/cloudfront/",
                      {
                        "Ref": "FrontEndDistributionToS3CloudFrontDistributionOrigin1S3OriginD10E575E",
                      },
                    ],
                  ],
                },
              },
            },
          ],
        },
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::CloudFront::Distribution",
    },
    "FrontEndDistributionToS3CloudFrontDistributionOrigin1S3OriginD10E575E": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Properties": {
        "CloudFrontOriginAccessIdentityConfig": {
          "Comment": "Identity for TestStack4FrontEndDistributionToS3CloudFrontDistributionOrigin14F3E9ADA",
        },
      },
      "Type": "AWS::CloudFront::CloudFrontOriginAccessIdentity",
    },
    "FrontEndDistributionToS3S3Bucket3A171D78": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "DeletionPolicy": "Retain",
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W35",
              "reason": "This S3 bucket does not require access logging.",
            },
          ],
        },
      },
      "Properties": {
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256",
              },
            },
          ],
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "NoncurrentVersionTransitions": [
                {
                  "StorageClass": "GLACIER",
                  "TransitionInDays": 90,
                },
              ],
              "Status": "Enabled",
            },
          ],
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true,
        },
        "Tags": [
          {
            "Key": "aws-cdk:cr-owned:a9b96825",
            "Value": "true",
          },
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
        "VersioningConfiguration": {
          "Status": "Enabled",
        },
      },
      "Type": "AWS::S3::Bucket",
      "UpdateReplacePolicy": "Retain",
    },
    "FrontEndDistributionToS3S3BucketPolicyF3A0315A": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "F16",
              "reason": "Public website bucket policy requires a wildcard principal",
            },
          ],
        },
      },
      "Properties": {
        "Bucket": {
          "Ref": "FrontEndDistributionToS3S3Bucket3A171D78",
        },
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:*",
              "Condition": {
                "Bool": {
                  "aws:SecureTransport": "false",
                },
              },
              "Effect": "Deny",
              "Principal": {
                "AWS": "*",
              },
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "FrontEndDistributionToS3S3Bucket3A171D78",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "FrontEndDistributionToS3S3Bucket3A171D78",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": "s3:GetObject",
              "Effect": "Allow",
              "Principal": {
                "CanonicalUser": {
                  "Fn::GetAtt": [
                    "FrontEndDistributionToS3CloudFrontDistributionOrigin1S3OriginD10E575E",
                    "S3CanonicalUserId",
                  ],
                },
              },
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    {
                      "Fn::GetAtt": [
                        "FrontEndDistributionToS3S3Bucket3A171D78",
                        "Arn",
                      ],
                    },
                    "/*",
                  ],
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::S3::BucketPolicy",
    },
  },
  "Rules": {
    "CheckBootstrapVersion": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Contains": [
                  [
                    "1",
                    "2",
                    "3",
                    "4",
                    "5",
                  ],
                  {
                    "Ref": "BootstrapVersion",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI.",
        },
      ],
    },
  },
}
`;

exports[`Serverless Image Handler Stack Snapshot with custom domain and different regions 1`] = `
{
  "Conditions": {
    "CommonResourcesDeployDemoUICondition308D3B09": {
      "Fn::Equals": [
        {
          "Ref": "DeployDemoUIParameter",
        },
        "Yes",
      ],
    },
    "CommonResourcesEnableCorsConditionA0615348": {
      "Fn::Equals": [
        {
          "Ref": "CorsEnabledParameter",
        },
        "Yes",
      ],
    },
    "CommonResourcesEnableDefaultFallbackImageConditionD1A10983": {
      "Fn::Equals": [
        {
          "Ref": "EnableDefaultFallbackImageParameter",
        },
        "Yes",
      ],
    },
    "CommonResourcesEnableSignatureCondition909DC7A1": {
      "Fn::Equals": [
        {
          "Ref": "EnableSignatureParameter",
        },
        "Yes",
      ],
    },
  },
  "Mappings": {
    "AWSCloudFrontPartitionHostedZoneIdMap": {
      "aws": {
        "zoneId": "Z2FDTNDATAQYW2",
      },
      "aws-cn": {
        "zoneId": "Z3RFFRIM2A3IF5",
      },
    },
  },
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "CORS Options",
          },
          "Parameters": [
            "CorsEnabledParameter",
            "CorsOriginParameter",
          ],
        },
        {
          "Label": {
            "default": "Image Sources",
          },
          "Parameters": [
            "SourceBucketsParameter",
          ],
        },
        {
          "Label": {
            "default": "Demo UI",
          },
          "Parameters": [
            "DeployDemoUIParameter",
          ],
        },
        {
          "Label": {
            "default": "Event Logging",
          },
          "Parameters": [
            "LogRetentionPeriodParameter",
          ],
        },
        {
          "Label": {
            "default": "Image URL Signature (Note: Enabling signature is not compatible with previous image URLs, which could result in broken image links. Please refer to the implementation guide for details: https://docs.aws.amazon.com/solutions/latest/serverless-image-handler/considerations.html)",
          },
          "Parameters": [
            "EnableSignatureParameter",
            "SecretsManagerSecretParameter",
            "SecretsManagerKeyParameter",
          ],
        },
        {
          "Label": {
            "default": "Default Fallback Image (Note: Enabling default fallback image returns the default fallback image instead of JSON object when error happens. Please refer to the implementation guide for details: https://docs.aws.amazon.com/solutions/latest/serverless-image-handler/considerations.html)",
          },
          "Parameters": [
            "EnableDefaultFallbackImageParameter",
            "FallbackImageS3BucketParameter",
            "FallbackImageS3KeyParameter",
          ],
        },
        {
          "Label": {
            "default": "Auto WebP",
          },
          "Parameters": [
            "AutoWebPParameter",
          ],
        },
      ],
      "ParameterLabels": {
        "AutoWebPParameter": {
          "default": "AutoWebP",
        },
        "CloudFrontPriceClassParameter": {
          "default": "CloudFront PriceClass",
        },
        "CorsEnabledParameter": {
          "default": "CORS Enabled",
        },
        "CorsOriginParameter": {
          "default": "CORS Origin",
        },
        "DeployDemoUIParameter": {
          "default": "Deploy Demo UI",
        },
        "EnableDefaultFallbackImageParameter": {
          "default": "Enable Default Fallback Image",
        },
        "EnableSignatureParameter": {
          "default": "Enable Signature",
        },
        "FallbackImageS3BucketParameter": {
          "default": "Fallback Image S3 Bucket",
        },
        "FallbackImageS3KeyParameter": {
          "default": "Fallback Image S3 Key",
        },
        "LogRetentionPeriodParameter": {
          "default": "Log Retention Period",
        },
        "SecretsManagerKeyParameter": {
          "default": "SecretsManager Key",
        },
        "SecretsManagerSecretParameter": {
          "default": "SecretsManager Secret",
        },
        "SourceBucketsParameter": {
          "default": "Source Buckets",
        },
      },
    },
  },
  "Outputs": {
    "ApiEndpoint": {
      "Description": "Link to API endpoint for sending image requests to.",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://",
            {
              "Fn::GetAtt": [
                "BackEndImageHandlerCloudFrontApiGatewayLambdaCloudFrontToApiGatewayCloudFrontDistribution03AA31B2",
                "DomainName",
              ],
            },
          ],
        ],
      },
    },
    "CorsEnabled": {
      "Description": "Indicates whether Cross-Origin Resource Sharing (CORS) has been enabled for the image handler API.",
      "Value": {
        "Ref": "CorsEnabledParameter",
      },
    },
    "CorsOrigin": {
      "Condition": "CommonResourcesEnableCorsConditionA0615348",
      "Description": "Origin value returned in the Access-Control-Allow-Origin header of image handler API responses.",
      "Value": {
        "Ref": "CorsOriginParameter",
      },
    },
    "CustomDomain": {
      "Description": "The custom domain name for this distribution",
      "Value": "cdn.example.com",
    },
    "DemoUrl": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Description": "Link to the demo user interface for the solution.",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://",
            {
              "Fn::GetAtt": [
                "FrontEndDistributionToS3CloudFrontDistribution15FE13D0",
                "DomainName",
              ],
            },
            "/index.html",
          ],
        ],
      },
    },
    "LogRetentionPeriod": {
      "Description": "Number of days for event logs from Lambda to be retained in CloudWatch.",
      "Value": {
        "Ref": "LogRetentionPeriodParameter",
      },
    },
    "SourceBuckets": {
      "Description": "Amazon S3 bucket location containing original image files.",
      "Value": {
        "Ref": "SourceBucketsParameter",
      },
    },
  },
  "Parameters": {
    "AutoWebPParameter": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Would you like to enable automatic WebP based on accept headers? Select 'Yes' if so.",
      "Type": "String",
    },
    "BootstrapVersion": {
      "Default": "/cdk-bootstrap/hnb659fds/version",
      "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]",
      "Type": "AWS::SSM::Parameter::Value<String>",
    },
    "CloudFrontPriceClassParameter": {
      "AllowedValues": [
        "PriceClass_All",
        "PriceClass_200",
        "PriceClass_100",
      ],
      "Default": "PriceClass_All",
      "Description": "The AWS CloudFront price class to use. For more information see: https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/PriceClass.html",
      "Type": "String",
    },
    "CorsEnabledParameter": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Would you like to enable Cross-Origin Resource Sharing (CORS) for the image handler API? Select 'Yes' if so.",
      "Type": "String",
    },
    "CorsOriginParameter": {
      "Default": "*",
      "Description": "If you selected 'Yes' above, please specify an origin value here. A wildcard (*) value will support any origin. We recommend specifying an origin (i.e. https://example.domain) to restrict cross-site access to your API.",
      "Type": "String",
    },
    "DeployDemoUIParameter": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "Yes",
      "Description": "Would you like to deploy a demo UI to explore the features and capabilities of this solution? This will create an additional Amazon S3 bucket and Amazon CloudFront distribution in your account.",
      "Type": "String",
    },
    "EnableDefaultFallbackImageParameter": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Would you like to enable the default fallback image? If so, select 'Yes' and provide FallbackImageS3Bucket and FallbackImageS3Key values.",
      "Type": "String",
    },
    "EnableSignatureParameter": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Would you like to enable the signature? If so, select 'Yes' and provide SecretsManagerSecret and SecretsManagerKey values.",
      "Type": "String",
    },
    "FallbackImageS3BucketParameter": {
      "Default": "",
      "Description": "The name of the Amazon S3 bucket which contains the default fallback image. e.g. my-fallback-image-bucket",
      "Type": "String",
    },
    "FallbackImageS3KeyParameter": {
      "Default": "",
      "Description": "The name of the default fallback image object key including prefix. e.g. prefix/image.jpg",
      "Type": "String",
    },
    "LogRetentionPeriodParameter": {
      "AllowedValues": [
        "1",
        "3",
        "5",
        "7",
        "14",
        "30",
        "60",
        "90",
        "120",
        "150",
        "180",
        "365",
        "400",
        "545",
        "731",
        "1827",
        "3653",
      ],
      "Default": "1",
      "Description": "This solution automatically logs events to Amazon CloudWatch. Select the amount of time for CloudWatch logs from this solution to be retained (in days).",
      "Type": "Number",
    },
    "SecretsManagerKeyParameter": {
      "Default": "",
      "Description": "The name of AWS Secrets Manager secret key. You need to create secret key with this key name. The secret value would be used to check signature.",
      "Type": "String",
    },
    "SecretsManagerSecretParameter": {
      "Default": "",
      "Description": "The name of AWS Secrets Manager secret. You need to create your secret under this name.",
      "Type": "String",
    },
    "SourceBucketsParameter": {
      "AllowedPattern": ".+",
      "Default": "defaultBucket, bucketNo2, bucketNo3, ...",
      "Description": "(Required) List the buckets (comma-separated) within your account that contain original image files. If you plan to use Thumbor or Custom image requests with this solution, the source bucket for those requests will be the first bucket listed in this field.",
      "Type": "String",
    },
  },
  "Resources": {
    "AppRegistry968496A3": {
      "Properties": {
        "Description": "Service Catalog application to track and manage all your resources for the solution sih",
        "Name": {
          "Fn::Join": [
            "-",
            [
              "AppRegistry",
              {
                "Ref": "AWS::StackName",
              },
              {
                "Ref": "AWS::Region",
              },
              {
                "Ref": "AWS::AccountId",
              },
            ],
          ],
        },
        "Tags": {
          "SolutionId": "S0ABC",
          "Solutions:ApplicationType": "AWS-Solutions",
          "Solutions:SolutionID": "S0ABC",
          "Solutions:SolutionName": "sih",
          "Solutions:SolutionVersion": "v6.2.5",
        },
      },
      "Type": "AWS::ServiceCatalogAppRegistry::Application",
    },
    "AppRegistryAssociation": {
      "Properties": {
        "Application": {
          "Fn::GetAtt": [
            "AppRegistry968496A3",
            "Id",
          ],
        },
        "Resource": {
          "Ref": "AWS::StackId",
        },
        "ResourceType": "CFN_STACK",
      },
      "Type": "AWS::ServiceCatalogAppRegistry::ResourceAssociation",
    },
    "BackEndARecordD2D9E3A6": {
      "Properties": {
        "AliasTarget": {
          "DNSName": {
            "Fn::GetAtt": [
              "BackEndImageHandlerCloudFrontApiGatewayLambdaCloudFrontToApiGatewayCloudFrontDistribution03AA31B2",
              "DomainName",
            ],
          },
          "HostedZoneId": {
            "Fn::FindInMap": [
              "AWSCloudFrontPartitionHostedZoneIdMap",
              {
                "Ref": "AWS::Partition",
              },
              "zoneId",
            ],
          },
        },
        "HostedZoneId": {
          "Fn::ImportValue": "HostedZoneTestStack1:ExportsOutputRefHostedZoneF1391A64D131F118",
        },
        "Name": "cdn.example.com.",
        "Type": "A",
      },
      "Type": "AWS::Route53::RecordSet",
    },
    "BackEndCachePolicy1DCE9B1B": {
      "Properties": {
        "CachePolicyConfig": {
          "DefaultTTL": 86400,
          "MaxTTL": 31536000,
          "MinTTL": 1,
          "Name": {
            "Fn::Join": [
              "",
              [
                "ServerlessImageHandler-",
                {
                  "Fn::GetAtt": [
                    "CommonResourcesCustomResourcesCustomResourceUuid64E7CCAD",
                    "UUID",
                  ],
                },
              ],
            ],
          },
          "ParametersInCacheKeyAndForwardedToOrigin": {
            "CookiesConfig": {
              "CookieBehavior": "none",
            },
            "EnableAcceptEncodingBrotli": false,
            "EnableAcceptEncodingGzip": false,
            "HeadersConfig": {
              "HeaderBehavior": "whitelist",
              "Headers": [
                "origin",
                "accept",
              ],
            },
            "QueryStringsConfig": {
              "QueryStringBehavior": "whitelist",
              "QueryStrings": [
                "signature",
                "edits",
                "headers",
                "effort",
                "outputFormat",
              ],
            },
          },
        },
      },
      "Type": "AWS::CloudFront::CachePolicy",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaApiAccessLogGroup9B786692": {
      "DeletionPolicy": "Retain",
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W84",
              "reason": "By default CloudWatchLogs LogGroups data is encrypted using the CloudWatch server-side encryption keys (AWS Managed Keys)",
            },
          ],
        },
      },
      "Properties": {
        "RetentionInDays": {
          "Ref": "LogRetentionPeriodParameter",
        },
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::Logs::LogGroup",
      "UpdateReplacePolicy": "Retain",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaCloudFrontToApiGatewayCloudFrontDistribution03AA31B2": {
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W70",
              "reason": "Since the distribution uses the CloudFront domain name, CloudFront automatically sets the security policy to TLSv1 regardless of the value of MinimumProtocolVersion",
            },
          ],
        },
      },
      "Properties": {
        "DistributionConfig": {
          "Aliases": [
            "cdn.example.com",
          ],
          "Comment": "Image Handler Distribution for Serverless Image Handler",
          "CustomErrorResponses": [
            {
              "ErrorCachingMinTTL": 600,
              "ErrorCode": 500,
            },
            {
              "ErrorCachingMinTTL": 600,
              "ErrorCode": 501,
            },
            {
              "ErrorCachingMinTTL": 600,
              "ErrorCode": 502,
            },
            {
              "ErrorCachingMinTTL": 600,
              "ErrorCode": 503,
            },
            {
              "ErrorCachingMinTTL": 600,
              "ErrorCode": 504,
            },
          ],
          "DefaultCacheBehavior": {
            "AllowedMethods": [
              "GET",
              "HEAD",
            ],
            "CachePolicyId": {
              "Ref": "BackEndCachePolicy1DCE9B1B",
            },
            "Compress": true,
            "FunctionAssociations": [
              {
                "EventType": "viewer-request",
                "FunctionARN": {
                  "Fn::GetAtt": [
                    "BackEndNormalizeAcceptHeaderFunctionA8503110",
                    "FunctionARN",
                  ],
                },
              },
            ],
            "OriginRequestPolicyId": {
              "Ref": "BackEndOriginRequestPolicy771345D7",
            },
            "TargetOriginId": "TestStack1BackEndImageHandlerCloudFrontApiGatewayLambdaCloudFrontToApiGatewayCloudFrontDistributionOrigin12122119A",
            "ViewerProtocolPolicy": "https-only",
          },
          "Enabled": true,
          "HttpVersion": "http2",
          "IPV6Enabled": true,
          "Logging": {
            "Bucket": {
              "Fn::Join": [
                "",
                [
                  {
                    "Fn::GetAtt": [
                      "CommonResourcesCustomResourcesLogBucketCustomResource2445A3AB",
                      "BucketName",
                    ],
                  },
                  ".s3.",
                  {
                    "Fn::GetAtt": [
                      "CommonResourcesCustomResourcesLogBucketCustomResource2445A3AB",
                      "Region",
                    ],
                  },
                  ".",
                  {
                    "Ref": "AWS::URLSuffix",
                  },
                ],
              ],
            },
            "Prefix": "api-cloudfront/",
          },
          "Origins": [
            {
              "CustomOriginConfig": {
                "OriginProtocolPolicy": "https-only",
                "OriginSSLProtocols": [
                  "TLSv1.1",
                  "TLSv1.2",
                ],
              },
              "DomainName": {
                "Fn::Join": [
                  "",
                  [
                    {
                      "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
                    },
                    ".execute-api.",
                    {
                      "Ref": "AWS::Region",
                    },
                    ".amazonaws.com",
                  ],
                ],
              },
              "Id": "TestStack1BackEndImageHandlerCloudFrontApiGatewayLambdaCloudFrontToApiGatewayCloudFrontDistributionOrigin12122119A",
              "OriginPath": "/image",
            },
          ],
          "PriceClass": {
            "Ref": "CloudFrontPriceClassParameter",
          },
          "ViewerCertificate": {
            "AcmCertificateArn": {
              "Fn::GetAtt": [
                "ExportsReader8B249524",
                "/cdk/exports/TestStack1/CertificateTestStack1useast1RefCertificateCustomCertificateDCB38E29A490B2D8",
              ],
            },
            "MinimumProtocolVersion": "TLSv1.2_2021",
            "SslSupportMethod": "sni-only",
          },
        },
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::CloudFront::Distribution",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109": {
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W59",
              "reason": "AWS::ApiGateway::Method AuthorizationType is set to 'NONE' because API Gateway behind CloudFront does not support AWS_IAM authentication",
            },
          ],
        },
      },
      "Properties": {
        "BinaryMediaTypes": [
          "*/*",
        ],
        "EndpointConfiguration": {
          "Types": [
            "REGIONAL",
          ],
        },
        "Name": "LambdaRestApi",
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::ApiGateway::RestApi",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiANYApiPermissionTestStack1BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiC5A60A19ANYD4D29295": {
      "Properties": {
        "Action": "lambda:InvokeFunction",
        "FunctionName": {
          "Fn::GetAtt": [
            "BackEndImageHandlerLambdaFunctionADEF7FF2",
            "Arn",
          ],
        },
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": {
          "Fn::Join": [
            "",
            [
              "arn:",
              {
                "Ref": "AWS::Partition",
              },
              ":execute-api:eu-west-2:",
              {
                "Ref": "AWS::AccountId",
              },
              ":",
              {
                "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
              },
              "/",
              {
                "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiDeploymentStageimageB55D20E3",
              },
              "/*/",
            ],
          ],
        },
      },
      "Type": "AWS::Lambda::Permission",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiANYApiPermissionTestTestStack1BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiC5A60A19ANYBE0F5C71": {
      "Properties": {
        "Action": "lambda:InvokeFunction",
        "FunctionName": {
          "Fn::GetAtt": [
            "BackEndImageHandlerLambdaFunctionADEF7FF2",
            "Arn",
          ],
        },
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": {
          "Fn::Join": [
            "",
            [
              "arn:",
              {
                "Ref": "AWS::Partition",
              },
              ":execute-api:eu-west-2:",
              {
                "Ref": "AWS::AccountId",
              },
              ":",
              {
                "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
              },
              "/test-invoke-stage/*/",
            ],
          ],
        },
      },
      "Type": "AWS::Lambda::Permission",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiANYE4494B31": {
      "Properties": {
        "AuthorizationType": "NONE",
        "HttpMethod": "ANY",
        "Integration": {
          "IntegrationHttpMethod": "POST",
          "Type": "AWS_PROXY",
          "Uri": {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":apigateway:eu-west-2:lambda:path/2015-03-31/functions/",
                {
                  "Fn::GetAtt": [
                    "BackEndImageHandlerLambdaFunctionADEF7FF2",
                    "Arn",
                  ],
                },
                "/invocations",
              ],
            ],
          },
        },
        "ResourceId": {
          "Fn::GetAtt": [
            "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
            "RootResourceId",
          ],
        },
        "RestApiId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
        },
      },
      "Type": "AWS::ApiGateway::Method",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiAccountE5522E5D": {
      "DependsOn": [
        "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
      ],
      "Properties": {
        "CloudWatchRoleArn": {
          "Fn::GetAtt": [
            "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiCloudWatchRole12575C4D",
            "Arn",
          ],
        },
      },
      "Type": "AWS::ApiGateway::Account",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiCloudWatchRole12575C4D": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "apigateway.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "Policies": [
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:DescribeLogGroups",
                    "logs:DescribeLogStreams",
                    "logs:PutLogEvents",
                    "logs:GetLogEvents",
                    "logs:FilterLogEvents",
                  ],
                  "Effect": "Allow",
                  "Resource": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:",
                        {
                          "Ref": "AWS::Partition",
                        },
                        ":logs:",
                        {
                          "Ref": "AWS::Region",
                        },
                        ":",
                        {
                          "Ref": "AWS::AccountId",
                        },
                        ":*",
                      ],
                    ],
                  },
                },
              ],
              "Version": "2012-10-17",
            },
            "PolicyName": "LambdaRestApiCloudWatchRolePolicy",
          },
        ],
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiDeployment663240D686b04a40ccb198432a533b03c818e607": {
      "DependsOn": [
        "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyANY8F9763E1",
        "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyBDF0A131",
        "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiANYE4494B31",
      ],
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W45",
              "reason": "ApiGateway has AccessLogging enabled in AWS::ApiGateway::Stage resource, but cfn_nag checks for it in AWS::ApiGateway::Deployment resource",
            },
          ],
        },
      },
      "Properties": {
        "Description": "Automatically created by the RestApi construct",
        "RestApiId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
        },
      },
      "Type": "AWS::ApiGateway::Deployment",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiDeploymentStageimageB55D20E3": {
      "Properties": {
        "AccessLogSetting": {
          "DestinationArn": {
            "Fn::GetAtt": [
              "BackEndImageHandlerCloudFrontApiGatewayLambdaApiAccessLogGroup9B786692",
              "Arn",
            ],
          },
          "Format": "{"requestId":"$context.requestId","ip":"$context.identity.sourceIp","user":"$context.identity.user","caller":"$context.identity.caller","requestTime":"$context.requestTime","httpMethod":"$context.httpMethod","resourcePath":"$context.resourcePath","status":"$context.status","protocol":"$context.protocol","responseLength":"$context.responseLength"}",
        },
        "DeploymentId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiDeployment663240D686b04a40ccb198432a533b03c818e607",
        },
        "MethodSettings": [
          {
            "DataTraceEnabled": false,
            "HttpMethod": "*",
            "LoggingLevel": "INFO",
            "ResourcePath": "/*",
          },
        ],
        "RestApiId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
        },
        "StageName": "image",
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
        "TracingEnabled": true,
      },
      "Type": "AWS::ApiGateway::Stage",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiUsagePlan76CA1E70": {
      "Properties": {
        "ApiStages": [
          {
            "ApiId": {
              "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
            },
            "Stage": {
              "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiDeploymentStageimageB55D20E3",
            },
            "Throttle": {},
          },
        ],
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::ApiGateway::UsagePlan",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyANY8F9763E1": {
      "Properties": {
        "AuthorizationType": "NONE",
        "HttpMethod": "ANY",
        "Integration": {
          "IntegrationHttpMethod": "POST",
          "Type": "AWS_PROXY",
          "Uri": {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":apigateway:eu-west-2:lambda:path/2015-03-31/functions/",
                {
                  "Fn::GetAtt": [
                    "BackEndImageHandlerLambdaFunctionADEF7FF2",
                    "Arn",
                  ],
                },
                "/invocations",
              ],
            ],
          },
        },
        "ResourceId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyBDF0A131",
        },
        "RestApiId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
        },
      },
      "Type": "AWS::ApiGateway::Method",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyANYApiPermissionTestStack1BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiC5A60A19ANYproxyAF94831D": {
      "Properties": {
        "Action": "lambda:InvokeFunction",
        "FunctionName": {
          "Fn::GetAtt": [
            "BackEndImageHandlerLambdaFunctionADEF7FF2",
            "Arn",
          ],
        },
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": {
          "Fn::Join": [
            "",
            [
              "arn:",
              {
                "Ref": "AWS::Partition",
              },
              ":execute-api:eu-west-2:",
              {
                "Ref": "AWS::AccountId",
              },
              ":",
              {
                "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
              },
              "/",
              {
                "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiDeploymentStageimageB55D20E3",
              },
              "/*/*",
            ],
          ],
        },
      },
      "Type": "AWS::Lambda::Permission",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyANYApiPermissionTestTestStack1BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiC5A60A19ANYproxy9F6C9981": {
      "Properties": {
        "Action": "lambda:InvokeFunction",
        "FunctionName": {
          "Fn::GetAtt": [
            "BackEndImageHandlerLambdaFunctionADEF7FF2",
            "Arn",
          ],
        },
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": {
          "Fn::Join": [
            "",
            [
              "arn:",
              {
                "Ref": "AWS::Partition",
              },
              ":execute-api:eu-west-2:",
              {
                "Ref": "AWS::AccountId",
              },
              ":",
              {
                "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
              },
              "/test-invoke-stage/*/*",
            ],
          ],
        },
      },
      "Type": "AWS::Lambda::Permission",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyBDF0A131": {
      "Properties": {
        "ParentId": {
          "Fn::GetAtt": [
            "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
            "RootResourceId",
          ],
        },
        "PathPart": "{proxy+}",
        "RestApiId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
        },
      },
      "Type": "AWS::ApiGateway::Resource",
    },
    "BackEndImageHandlerFunctionPolicy437940B5": {
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W12",
              "reason": "rekognition:DetectFaces requires '*' resources.",
            },
          ],
        },
      },
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents",
              ],
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition",
                    },
                    ":logs:eu-west-2:",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    ":log-group:/aws/lambda/*",
                  ],
                ],
              },
            },
            {
              "Action": [
                "s3:GetObject",
                "s3:PutObject",
                "s3:ListBucket",
              ],
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition",
                    },
                    ":s3:::*",
                  ],
                ],
              },
            },
            {
              "Action": [
                "rekognition:DetectFaces",
                "rekognition:DetectModerationLabels",
              ],
              "Effect": "Allow",
              "Resource": "*",
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "BackEndImageHandlerFunctionPolicy437940B5",
        "Roles": [
          {
            "Ref": "BackEndImageHandlerFunctionRoleABF81E5C",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "BackEndImageHandlerFunctionRoleABF81E5C": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "BackEndImageHandlerLambdaFunctionADEF7FF2": {
      "DependsOn": [
        "BackEndImageHandlerFunctionRoleABF81E5C",
      ],
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W58",
              "reason": "The function does have permission to write CloudWatch Logs.",
            },
            {
              "id": "W89",
              "reason": "The Lambda function does not require any VPC connection at all.",
            },
            {
              "id": "W92",
              "reason": "The Lambda function does not require ReservedConcurrentExecutions.",
            },
          ],
        },
      },
      "Properties": {
        "Code": {
          "S3Bucket": {
            "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-eu-west-2",
          },
          "S3Key": "Omitted to remove snapshot dependency on hash",
        },
        "Description": "sih (v6.2.5): Performs image edits and manipulations",
        "Environment": {
          "Variables": {
            "AUTO_WEBP": {
              "Ref": "AutoWebPParameter",
            },
            "AWS_NODEJS_CONNECTION_REUSE_ENABLED": "1",
            "CORS_ENABLED": {
              "Ref": "CorsEnabledParameter",
            },
            "CORS_ORIGIN": {
              "Ref": "CorsOriginParameter",
            },
            "DEFAULT_FALLBACK_IMAGE_BUCKET": {
              "Ref": "FallbackImageS3BucketParameter",
            },
            "DEFAULT_FALLBACK_IMAGE_KEY": {
              "Ref": "FallbackImageS3KeyParameter",
            },
            "ENABLE_DEFAULT_FALLBACK_IMAGE": {
              "Ref": "EnableDefaultFallbackImageParameter",
            },
            "ENABLE_SIGNATURE": {
              "Ref": "EnableSignatureParameter",
            },
            "REWRITE_MATCH_PATTERN": "",
            "REWRITE_SUBSTITUTION": "",
            "SECRETS_MANAGER": {
              "Ref": "SecretsManagerSecretParameter",
            },
            "SECRET_KEY": {
              "Ref": "SecretsManagerKeyParameter",
            },
            "SOURCE_BUCKETS": {
              "Ref": "SourceBucketsParameter",
            },
          },
        },
        "Handler": "index.handler",
        "MemorySize": 1024,
        "Role": {
          "Fn::GetAtt": [
            "BackEndImageHandlerFunctionRoleABF81E5C",
            "Arn",
          ],
        },
        "Runtime": "nodejs20.x",
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
        "Timeout": 29,
      },
      "Type": "AWS::Lambda::Function",
    },
    "BackEndImageHandlerLogGroupA0941EEC": {
      "DeletionPolicy": "Retain",
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W84",
              "reason": "CloudWatch log group is always encrypted by default.",
            },
          ],
        },
      },
      "Properties": {
        "LogGroupName": {
          "Fn::Join": [
            "",
            [
              "/aws/lambda/",
              {
                "Ref": "BackEndImageHandlerLambdaFunctionADEF7FF2",
              },
            ],
          ],
        },
        "RetentionInDays": {
          "Ref": "LogRetentionPeriodParameter",
        },
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::Logs::LogGroup",
      "UpdateReplacePolicy": "Retain",
    },
    "BackEndNormalizeAcceptHeaderFunctionA8503110": {
      "Properties": {
        "AutoPublish": true,
        "FunctionCode": "
function handler(event) {
  if (event.request.headers && event.request.headers.accept && event.request.headers.accept.value) {
    let resultingHeader = "image/jpg";
    const acceptheadervalue = event.request.headers.accept.value;
    if (acceptheadervalue.includes("image/webp")) {
      resultingHeader = "image/webp";
    }
    event.request.headers.accept = { value: resultingHeader };
  }
  return event.request;
}
",
        "FunctionConfig": {
          "Comment": {
            "Fn::Join": [
              "",
              [
                "normalize-accept-headers-",
                {
                  "Ref": "AWS::Region",
                },
              ],
            ],
          },
          "Runtime": "cloudfront-js-1.0",
        },
        "Name": {
          "Fn::Join": [
            "",
            [
              "normalize-accept-headers-",
              {
                "Ref": "AWS::Region",
              },
            ],
          ],
        },
      },
      "Type": "AWS::CloudFront::Function",
    },
    "BackEndOriginRequestPolicy771345D7": {
      "Properties": {
        "OriginRequestPolicyConfig": {
          "CookiesConfig": {
            "CookieBehavior": "none",
          },
          "HeadersConfig": {
            "HeaderBehavior": "whitelist",
            "Headers": [
              "origin",
              "accept",
            ],
          },
          "Name": {
            "Fn::Join": [
              "",
              [
                "ServerlessImageHandler-",
                {
                  "Fn::GetAtt": [
                    "CommonResourcesCustomResourcesCustomResourceUuid64E7CCAD",
                    "UUID",
                  ],
                },
              ],
            ],
          },
          "QueryStringsConfig": {
            "QueryStringBehavior": "whitelist",
            "QueryStrings": [
              "signature",
              "edits",
              "headers",
              "effort",
              "outputFormat",
            ],
          },
        },
      },
      "Type": "AWS::CloudFront::OriginRequestPolicy",
    },
    "CommonResourcesCustomResourcesCustomResourceAnonymousMetric51363F57": {
      "DeletionPolicy": "Delete",
      "Properties": {
        "AnonymousData": "No",
        "AutoWebP": {
          "Ref": "AutoWebPParameter",
        },
        "CorsEnabled": {
          "Ref": "CorsEnabledParameter",
        },
        "CustomAction": "sendMetric",
        "CustomDomain": "cdn.example.com",
        "DeployDemoUi": {
          "Ref": "DeployDemoUIParameter",
        },
        "EnableDefaultFallbackImage": {
          "Ref": "EnableDefaultFallbackImageParameter",
        },
        "EnableSignature": {
          "Ref": "EnableSignatureParameter",
        },
        "LogRetentionPeriod": {
          "Ref": "LogRetentionPeriodParameter",
        },
        "Region": {
          "Ref": "AWS::Region",
        },
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
        "SourceBuckets": {
          "Ref": "SourceBucketsParameter",
        },
        "UUID": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceUuid64E7CCAD",
            "UUID",
          ],
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesCustomResourceCheckFallbackImage6CE45571": {
      "Condition": "CommonResourcesEnableDefaultFallbackImageConditionD1A10983",
      "DeletionPolicy": "Delete",
      "Properties": {
        "CustomAction": "checkFallbackImage",
        "FallbackImageS3Bucket": {
          "Ref": "FallbackImageS3BucketParameter",
        },
        "FallbackImageS3Key": {
          "Ref": "FallbackImageS3KeyParameter",
        },
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesCustomResourceCheckSecretsManagerAEEEC776": {
      "Condition": "CommonResourcesEnableSignatureCondition909DC7A1",
      "DeletionPolicy": "Delete",
      "Properties": {
        "CustomAction": "checkSecretsManager",
        "SecretsManagerKey": {
          "Ref": "SecretsManagerKeyParameter",
        },
        "SecretsManagerName": {
          "Ref": "SecretsManagerSecretParameter",
        },
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesCustomResourceCheckSourceBucketsA313C9B7": {
      "DeletionPolicy": "Delete",
      "Properties": {
        "CustomAction": "checkSourceBuckets",
        "Region": {
          "Ref": "AWS::Region",
        },
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
        "SourceBuckets": {
          "Ref": "SourceBucketsParameter",
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesCustomResourceFunction0D924235": {
      "DependsOn": [
        "CommonResourcesCustomResourcesCustomResourceRole8958A1ED",
      ],
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W58",
              "reason": "The function does have permission to write CloudWatch Logs.",
            },
            {
              "id": "W89",
              "reason": "The Lambda function does not require any VPC connection at all.",
            },
            {
              "id": "W92",
              "reason": "The Lambda function does not require ReservedConcurrentExecutions.",
            },
          ],
        },
      },
      "Properties": {
        "Code": {
          "S3Bucket": {
            "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-eu-west-2",
          },
          "S3Key": "Omitted to remove snapshot dependency on hash",
        },
        "Description": "sih (v6.2.5): Custom resource",
        "Environment": {
          "Variables": {
            "AWS_NODEJS_CONNECTION_REUSE_ENABLED": "1",
            "RETRY_SECONDS": "5",
            "SOLUTION_ID": "S0ABC",
            "SOLUTION_VERSION": "v6.2.5",
          },
        },
        "Handler": "index.handler",
        "MemorySize": 128,
        "Role": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceRole8958A1ED",
            "Arn",
          ],
        },
        "Runtime": "nodejs20.x",
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
        "Timeout": 60,
      },
      "Type": "AWS::Lambda::Function",
    },
    "CommonResourcesCustomResourcesCustomResourceRole8958A1ED": {
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W11",
              "reason": "Allow '*' because it is required for making DescribeRegions API call as it doesn't support resource-level permissions and require to choose all resources.",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "Path": "/",
        "Policies": [
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents",
                  ],
                  "Effect": "Allow",
                  "Resource": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:",
                        {
                          "Ref": "AWS::Partition",
                        },
                        ":logs:eu-west-2:",
                        {
                          "Ref": "AWS::AccountId",
                        },
                        ":log-group:/aws/lambda/*",
                      ],
                    ],
                  },
                },
                {
                  "Action": [
                    "s3:putBucketAcl",
                    "s3:putEncryptionConfiguration",
                    "s3:putBucketPolicy",
                    "s3:CreateBucket",
                    "s3:GetObject",
                    "s3:PutObject",
                    "s3:ListBucket",
                    "s3:PutBucketOwnershipControls",
                  ],
                  "Effect": "Allow",
                  "Resource": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:",
                        {
                          "Ref": "AWS::Partition",
                        },
                        ":s3:::*",
                      ],
                    ],
                  },
                },
              ],
              "Version": "2012-10-17",
            },
            "PolicyName": "CloudWatchLogsPolicy",
          },
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": "ec2:DescribeRegions",
                  "Effect": "Allow",
                  "Resource": "*",
                },
              ],
              "Version": "2012-10-17",
            },
            "PolicyName": "EC2Policy",
          },
        ],
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "CommonResourcesCustomResourcesCustomResourceUuid64E7CCAD": {
      "DeletionPolicy": "Delete",
      "Properties": {
        "CustomAction": "createUuid",
        "Region": {
          "Ref": "AWS::Region",
        },
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesDeployWebsiteAwsCliLayerBC025F39": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Properties": {
        "Content": {
          "S3Bucket": {
            "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-eu-west-2",
          },
          "S3Key": "Omitted to remove snapshot dependency on hash",
        },
        "Description": "/opt/awscli/aws",
      },
      "Type": "AWS::Lambda::LayerVersion",
    },
    "CommonResourcesCustomResourcesDeployWebsiteCustomResourceECB9B136": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "DeletionPolicy": "Delete",
      "Properties": {
        "DestinationBucketName": {
          "Ref": "FrontEndDistributionToS3S3Bucket3A171D78",
        },
        "Exclude": [
          "demo-ui-config.js",
        ],
        "Prune": true,
        "ServiceToken": {
          "Fn::GetAtt": [
            "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756C81C01536",
            "Arn",
          ],
        },
        "SourceBucketNames": [
          {
            "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-eu-west-2",
          },
        ],
        "SourceObjectKeys": [
          "c301c2cce52bb1b36720a115d657907f3ec9fa20bd385b4d81bf451fbe77fe4b.zip",
        ],
      },
      "Type": "Custom::CDKBucketDeployment",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesLogBucketCustomResource2445A3AB": {
      "DeletionPolicy": "Delete",
      "Properties": {
        "BucketSuffix": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AWS::StackName",
              },
              "-",
              {
                "Ref": "AWS::Region",
              },
              "-",
              {
                "Ref": "AWS::AccountId",
              },
            ],
          ],
        },
        "CustomAction": "createCloudFrontLoggingBucket",
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesPutWebsiteConfigC4E435F3": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "DeletionPolicy": "Delete",
      "Properties": {
        "ConfigItem": {
          "apiEndpoint": {
            "Fn::Join": [
              "",
              [
                "https://",
                {
                  "Fn::GetAtt": [
                    "BackEndImageHandlerCloudFrontApiGatewayLambdaCloudFrontToApiGatewayCloudFrontDistribution03AA31B2",
                    "DomainName",
                  ],
                },
              ],
            ],
          },
        },
        "CustomAction": "putConfigFile",
        "DestS3Bucket": {
          "Ref": "FrontEndDistributionToS3S3Bucket3A171D78",
        },
        "DestS3key": "demo-ui-config.js",
        "Region": {
          "Ref": "AWS::Region",
        },
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesSecretsManagerPolicy45FE005E": {
      "Condition": "CommonResourcesEnableSignatureCondition909DC7A1",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "secretsmanager:GetSecretValue",
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition",
                    },
                    ":secretsmanager:",
                    {
                      "Ref": "AWS::Region",
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    ":secret:",
                    {
                      "Ref": "SecretsManagerSecretParameter",
                    },
                    "*",
                  ],
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "CommonResourcesSecretsManagerPolicy45FE005E",
        "Roles": [
          {
            "Ref": "CommonResourcesCustomResourcesCustomResourceRole8958A1ED",
          },
          {
            "Ref": "BackEndImageHandlerFunctionRoleABF81E5C",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756C81C01536": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "DependsOn": [
        "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRoleDefaultPolicy88902FDF",
        "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRole89A01265",
      ],
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W58",
              "reason": "The function does have permission to write CloudWatch Logs.",
            },
            {
              "id": "W89",
              "reason": "The Lambda function does not require any VPC connection at all.",
            },
            {
              "id": "W92",
              "reason": "The Lambda function does not require ReservedConcurrentExecutions.",
            },
          ],
        },
      },
      "Properties": {
        "Code": {
          "S3Bucket": {
            "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-eu-west-2",
          },
          "S3Key": "Omitted to remove snapshot dependency on hash",
        },
        "Environment": {
          "Variables": {
            "AWS_CA_BUNDLE": "/etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem",
          },
        },
        "Handler": "index.handler",
        "Layers": [
          {
            "Ref": "CommonResourcesCustomResourcesDeployWebsiteAwsCliLayerBC025F39",
          },
        ],
        "Role": {
          "Fn::GetAtt": [
            "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRole89A01265",
            "Arn",
          ],
        },
        "Runtime": "python3.9",
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
        "Timeout": 900,
      },
      "Type": "AWS::Lambda::Function",
    },
    "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRole89A01265": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
        ],
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRoleDefaultPolicy88902FDF": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "s3:GetObject*",
                "s3:GetBucket*",
                "s3:List*",
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-eu-west-2",
                      },
                    ],
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-eu-west-2",
                      },
                      "/*",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": [
                "s3:GetObject*",
                "s3:GetBucket*",
                "s3:List*",
                "s3:DeleteObject*",
                "s3:PutObject",
                "s3:PutObjectLegalHold",
                "s3:PutObjectRetention",
                "s3:PutObjectTagging",
                "s3:PutObjectVersionTagging",
                "s3:Abort*",
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "FrontEndDistributionToS3S3Bucket3A171D78",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "FrontEndDistributionToS3S3Bucket3A171D78",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRoleDefaultPolicy88902FDF",
        "Roles": [
          {
            "Ref": "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRole89A01265",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "CustomCrossRegionExportReaderCustomResourceProviderHandler46647B68": {
      "DependsOn": [
        "CustomCrossRegionExportReaderCustomResourceProviderRole10531BBD",
      ],
      "Properties": {
        "Code": {
          "S3Bucket": {
            "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-eu-west-2",
          },
          "S3Key": "Omitted to remove snapshot dependency on hash",
        },
        "Handler": "__entrypoint__.handler",
        "MemorySize": 128,
        "Role": {
          "Fn::GetAtt": [
            "CustomCrossRegionExportReaderCustomResourceProviderRole10531BBD",
            "Arn",
          ],
        },
        "Runtime": "nodejs18.x",
        "Timeout": 900,
      },
      "Type": "AWS::Lambda::Function",
    },
    "CustomCrossRegionExportReaderCustomResourceProviderRole10531BBD": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Sub": "arn:\${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
          },
        ],
        "Policies": [
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "ssm:AddTagsToResource",
                    "ssm:RemoveTagsFromResource",
                    "ssm:GetParameters",
                  ],
                  "Effect": "Allow",
                  "Resource": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:",
                        {
                          "Ref": "AWS::Partition",
                        },
                        ":ssm:eu-west-2:",
                        {
                          "Ref": "AWS::AccountId",
                        },
                        ":parameter/cdk/exports/TestStack1/*",
                      ],
                    ],
                  },
                },
              ],
              "Version": "2012-10-17",
            },
            "PolicyName": "Inline",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "DefaultApplicationAttributeGroup41AD7209": {
      "Properties": {
        "Attributes": {
          "applicationType": "AWS-Solutions",
          "solutionID": "S0ABC",
          "solutionName": "sih",
          "version": "v6.2.5",
        },
        "Description": "Attribute group for solution information",
        "Name": {
          "Fn::Join": [
            "",
            [
              "A30-AppRegistry-",
              {
                "Ref": "AWS::StackName",
              },
            ],
          ],
        },
        "Tags": {
          "SolutionId": "S0ABC",
        },
      },
      "Type": "AWS::ServiceCatalogAppRegistry::AttributeGroup",
    },
    "DefaultApplicationAttributeGroupApplicationAttributeGroupAssociation22e4e4ea3ada5864C3BC": {
      "Properties": {
        "Application": {
          "Fn::GetAtt": [
            "AppRegistry968496A3",
            "Id",
          ],
        },
        "AttributeGroup": {
          "Fn::GetAtt": [
            "DefaultApplicationAttributeGroup41AD7209",
            "Id",
          ],
        },
      },
      "Type": "AWS::ServiceCatalogAppRegistry::AttributeGroupAssociation",
    },
    "ExportsReader8B249524": {
      "DeletionPolicy": "Delete",
      "Properties": {
        "ReaderProps": {
          "imports": {
            "/cdk/exports/TestStack1/CertificateTestStack1useast1RefCertificateCustomCertificateDCB38E29A490B2D8": "{{resolve:ssm:/cdk/exports/TestStack1/CertificateTestStack1useast1RefCertificateCustomCertificateDCB38E29A490B2D8}}",
          },
          "prefix": "TestStack1",
          "region": "eu-west-2",
        },
        "ServiceToken": {
          "Fn::GetAtt": [
            "CustomCrossRegionExportReaderCustomResourceProviderHandler46647B68",
            "Arn",
          ],
        },
      },
      "Type": "Custom::CrossRegionExportReader",
      "UpdateReplacePolicy": "Delete",
    },
    "FrontEndDistributionToS3CloudFrontDistribution15FE13D0": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W70",
              "reason": "Since the distribution uses the CloudFront domain name, CloudFront automatically sets the security policy to TLSv1 regardless of the value of MinimumProtocolVersion",
            },
          ],
        },
      },
      "Properties": {
        "DistributionConfig": {
          "Comment": "Demo UI Distribution for Serverless Image Handler",
          "CustomErrorResponses": [
            {
              "ErrorCode": 403,
              "ResponseCode": 200,
              "ResponsePagePath": "/index.html",
            },
            {
              "ErrorCode": 404,
              "ResponseCode": 200,
              "ResponsePagePath": "/index.html",
            },
          ],
          "DefaultCacheBehavior": {
            "CachePolicyId": "658327ea-f89d-4fab-a63d-7e88639e58f6",
            "Compress": true,
            "TargetOriginId": "TestStack1FrontEndDistributionToS3CloudFrontDistributionOrigin183E4F132",
            "ViewerProtocolPolicy": "redirect-to-https",
          },
          "DefaultRootObject": "index.html",
          "Enabled": true,
          "HttpVersion": "http2",
          "IPV6Enabled": true,
          "Logging": {
            "Bucket": {
              "Fn::Join": [
                "",
                [
                  {
                    "Fn::GetAtt": [
                      "CommonResourcesCustomResourcesLogBucketCustomResource2445A3AB",
                      "BucketName",
                    ],
                  },
                  ".s3.",
                  {
                    "Fn::GetAtt": [
                      "CommonResourcesCustomResourcesLogBucketCustomResource2445A3AB",
                      "Region",
                    ],
                  },
                  ".",
                  {
                    "Ref": "AWS::URLSuffix",
                  },
                ],
              ],
            },
            "Prefix": "ui-cloudfront/",
          },
          "Origins": [
            {
              "DomainName": {
                "Fn::GetAtt": [
                  "FrontEndDistributionToS3S3Bucket3A171D78",
                  "RegionalDomainName",
                ],
              },
              "Id": "TestStack1FrontEndDistributionToS3CloudFrontDistributionOrigin183E4F132",
              "S3OriginConfig": {
                "OriginAccessIdentity": {
                  "Fn::Join": [
                    "",
                    [
                      "origin-access-identity/cloudfront/",
                      {
                        "Ref": "FrontEndDistributionToS3CloudFrontDistributionOrigin1S3OriginD10E575E",
                      },
                    ],
                  ],
                },
              },
            },
          ],
        },
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::CloudFront::Distribution",
    },
    "FrontEndDistributionToS3CloudFrontDistributionOrigin1S3OriginD10E575E": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Properties": {
        "CloudFrontOriginAccessIdentityConfig": {
          "Comment": "Identity for TestStack1FrontEndDistributionToS3CloudFrontDistributionOrigin183E4F132",
        },
      },
      "Type": "AWS::CloudFront::CloudFrontOriginAccessIdentity",
    },
    "FrontEndDistributionToS3S3Bucket3A171D78": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "DeletionPolicy": "Retain",
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W35",
              "reason": "This S3 bucket does not require access logging.",
            },
          ],
        },
      },
      "Properties": {
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256",
              },
            },
          ],
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "NoncurrentVersionTransitions": [
                {
                  "StorageClass": "GLACIER",
                  "TransitionInDays": 90,
                },
              ],
              "Status": "Enabled",
            },
          ],
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true,
        },
        "Tags": [
          {
            "Key": "aws-cdk:cr-owned:b10b3a5b",
            "Value": "true",
          },
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
        "VersioningConfiguration": {
          "Status": "Enabled",
        },
      },
      "Type": "AWS::S3::Bucket",
      "UpdateReplacePolicy": "Retain",
    },
    "FrontEndDistributionToS3S3BucketPolicyF3A0315A": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "F16",
              "reason": "Public website bucket policy requires a wildcard principal",
            },
          ],
        },
      },
      "Properties": {
        "Bucket": {
          "Ref": "FrontEndDistributionToS3S3Bucket3A171D78",
        },
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:*",
              "Condition": {
                "Bool": {
                  "aws:SecureTransport": "false",
                },
              },
              "Effect": "Deny",
              "Principal": {
                "AWS": "*",
              },
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "FrontEndDistributionToS3S3Bucket3A171D78",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "FrontEndDistributionToS3S3Bucket3A171D78",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": "s3:GetObject",
              "Effect": "Allow",
              "Principal": {
                "CanonicalUser": {
                  "Fn::GetAtt": [
                    "FrontEndDistributionToS3CloudFrontDistributionOrigin1S3OriginD10E575E",
                    "S3CanonicalUserId",
                  ],
                },
              },
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    {
                      "Fn::GetAtt": [
                        "FrontEndDistributionToS3S3Bucket3A171D78",
                        "Arn",
                      ],
                    },
                    "/*",
                  ],
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::S3::BucketPolicy",
    },
  },
  "Rules": {
    "CheckBootstrapVersion": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Contains": [
                  [
                    "1",
                    "2",
                    "3",
                    "4",
                    "5",
                  ],
                  {
                    "Ref": "BootstrapVersion",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI.",
        },
      ],
    },
  },
}
`;

exports[`Serverless Image Handler Stack Snapshot with custom domain and everything in us-east-1 1`] = `
{
  "Conditions": {
    "CommonResourcesDeployDemoUICondition308D3B09": {
      "Fn::Equals": [
        {
          "Ref": "DeployDemoUIParameter",
        },
        "Yes",
      ],
    },
    "CommonResourcesEnableCorsConditionA0615348": {
      "Fn::Equals": [
        {
          "Ref": "CorsEnabledParameter",
        },
        "Yes",
      ],
    },
    "CommonResourcesEnableDefaultFallbackImageConditionD1A10983": {
      "Fn::Equals": [
        {
          "Ref": "EnableDefaultFallbackImageParameter",
        },
        "Yes",
      ],
    },
    "CommonResourcesEnableSignatureCondition909DC7A1": {
      "Fn::Equals": [
        {
          "Ref": "EnableSignatureParameter",
        },
        "Yes",
      ],
    },
  },
  "Mappings": {
    "AWSCloudFrontPartitionHostedZoneIdMap": {
      "aws": {
        "zoneId": "Z2FDTNDATAQYW2",
      },
      "aws-cn": {
        "zoneId": "Z3RFFRIM2A3IF5",
      },
    },
  },
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "CORS Options",
          },
          "Parameters": [
            "CorsEnabledParameter",
            "CorsOriginParameter",
          ],
        },
        {
          "Label": {
            "default": "Image Sources",
          },
          "Parameters": [
            "SourceBucketsParameter",
          ],
        },
        {
          "Label": {
            "default": "Demo UI",
          },
          "Parameters": [
            "DeployDemoUIParameter",
          ],
        },
        {
          "Label": {
            "default": "Event Logging",
          },
          "Parameters": [
            "LogRetentionPeriodParameter",
          ],
        },
        {
          "Label": {
            "default": "Image URL Signature (Note: Enabling signature is not compatible with previous image URLs, which could result in broken image links. Please refer to the implementation guide for details: https://docs.aws.amazon.com/solutions/latest/serverless-image-handler/considerations.html)",
          },
          "Parameters": [
            "EnableSignatureParameter",
            "SecretsManagerSecretParameter",
            "SecretsManagerKeyParameter",
          ],
        },
        {
          "Label": {
            "default": "Default Fallback Image (Note: Enabling default fallback image returns the default fallback image instead of JSON object when error happens. Please refer to the implementation guide for details: https://docs.aws.amazon.com/solutions/latest/serverless-image-handler/considerations.html)",
          },
          "Parameters": [
            "EnableDefaultFallbackImageParameter",
            "FallbackImageS3BucketParameter",
            "FallbackImageS3KeyParameter",
          ],
        },
        {
          "Label": {
            "default": "Auto WebP",
          },
          "Parameters": [
            "AutoWebPParameter",
          ],
        },
      ],
      "ParameterLabels": {
        "AutoWebPParameter": {
          "default": "AutoWebP",
        },
        "CloudFrontPriceClassParameter": {
          "default": "CloudFront PriceClass",
        },
        "CorsEnabledParameter": {
          "default": "CORS Enabled",
        },
        "CorsOriginParameter": {
          "default": "CORS Origin",
        },
        "DeployDemoUIParameter": {
          "default": "Deploy Demo UI",
        },
        "EnableDefaultFallbackImageParameter": {
          "default": "Enable Default Fallback Image",
        },
        "EnableSignatureParameter": {
          "default": "Enable Signature",
        },
        "FallbackImageS3BucketParameter": {
          "default": "Fallback Image S3 Bucket",
        },
        "FallbackImageS3KeyParameter": {
          "default": "Fallback Image S3 Key",
        },
        "LogRetentionPeriodParameter": {
          "default": "Log Retention Period",
        },
        "SecretsManagerKeyParameter": {
          "default": "SecretsManager Key",
        },
        "SecretsManagerSecretParameter": {
          "default": "SecretsManager Secret",
        },
        "SourceBucketsParameter": {
          "default": "Source Buckets",
        },
      },
    },
  },
  "Outputs": {
    "ApiEndpoint": {
      "Description": "Link to API endpoint for sending image requests to.",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://",
            {
              "Fn::GetAtt": [
                "BackEndImageHandlerCloudFrontApiGatewayLambdaCloudFrontToApiGatewayCloudFrontDistribution03AA31B2",
                "DomainName",
              ],
            },
          ],
        ],
      },
    },
    "CorsEnabled": {
      "Description": "Indicates whether Cross-Origin Resource Sharing (CORS) has been enabled for the image handler API.",
      "Value": {
        "Ref": "CorsEnabledParameter",
      },
    },
    "CorsOrigin": {
      "Condition": "CommonResourcesEnableCorsConditionA0615348",
      "Description": "Origin value returned in the Access-Control-Allow-Origin header of image handler API responses.",
      "Value": {
        "Ref": "CorsOriginParameter",
      },
    },
    "CustomDomain": {
      "Description": "The custom domain name for this distribution",
      "Value": "cdn.example.com",
    },
    "DemoUrl": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Description": "Link to the demo user interface for the solution.",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://",
            {
              "Fn::GetAtt": [
                "FrontEndDistributionToS3CloudFrontDistribution15FE13D0",
                "DomainName",
              ],
            },
            "/index.html",
          ],
        ],
      },
    },
    "LogRetentionPeriod": {
      "Description": "Number of days for event logs from Lambda to be retained in CloudWatch.",
      "Value": {
        "Ref": "LogRetentionPeriodParameter",
      },
    },
    "SourceBuckets": {
      "Description": "Amazon S3 bucket location containing original image files.",
      "Value": {
        "Ref": "SourceBucketsParameter",
      },
    },
  },
  "Parameters": {
    "AutoWebPParameter": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Would you like to enable automatic WebP based on accept headers? Select 'Yes' if so.",
      "Type": "String",
    },
    "BootstrapVersion": {
      "Default": "/cdk-bootstrap/hnb659fds/version",
      "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]",
      "Type": "AWS::SSM::Parameter::Value<String>",
    },
    "CloudFrontPriceClassParameter": {
      "AllowedValues": [
        "PriceClass_All",
        "PriceClass_200",
        "PriceClass_100",
      ],
      "Default": "PriceClass_All",
      "Description": "The AWS CloudFront price class to use. For more information see: https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/PriceClass.html",
      "Type": "String",
    },
    "CorsEnabledParameter": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Would you like to enable Cross-Origin Resource Sharing (CORS) for the image handler API? Select 'Yes' if so.",
      "Type": "String",
    },
    "CorsOriginParameter": {
      "Default": "*",
      "Description": "If you selected 'Yes' above, please specify an origin value here. A wildcard (*) value will support any origin. We recommend specifying an origin (i.e. https://example.domain) to restrict cross-site access to your API.",
      "Type": "String",
    },
    "DeployDemoUIParameter": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "Yes",
      "Description": "Would you like to deploy a demo UI to explore the features and capabilities of this solution? This will create an additional Amazon S3 bucket and Amazon CloudFront distribution in your account.",
      "Type": "String",
    },
    "EnableDefaultFallbackImageParameter": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Would you like to enable the default fallback image? If so, select 'Yes' and provide FallbackImageS3Bucket and FallbackImageS3Key values.",
      "Type": "String",
    },
    "EnableSignatureParameter": {
      "AllowedValues": [
        "Yes",
        "No",
      ],
      "Default": "No",
      "Description": "Would you like to enable the signature? If so, select 'Yes' and provide SecretsManagerSecret and SecretsManagerKey values.",
      "Type": "String",
    },
    "FallbackImageS3BucketParameter": {
      "Default": "",
      "Description": "The name of the Amazon S3 bucket which contains the default fallback image. e.g. my-fallback-image-bucket",
      "Type": "String",
    },
    "FallbackImageS3KeyParameter": {
      "Default": "",
      "Description": "The name of the default fallback image object key including prefix. e.g. prefix/image.jpg",
      "Type": "String",
    },
    "LogRetentionPeriodParameter": {
      "AllowedValues": [
        "1",
        "3",
        "5",
        "7",
        "14",
        "30",
        "60",
        "90",
        "120",
        "150",
        "180",
        "365",
        "400",
        "545",
        "731",
        "1827",
        "3653",
      ],
      "Default": "1",
      "Description": "This solution automatically logs events to Amazon CloudWatch. Select the amount of time for CloudWatch logs from this solution to be retained (in days).",
      "Type": "Number",
    },
    "SecretsManagerKeyParameter": {
      "Default": "",
      "Description": "The name of AWS Secrets Manager secret key. You need to create secret key with this key name. The secret value would be used to check signature.",
      "Type": "String",
    },
    "SecretsManagerSecretParameter": {
      "Default": "",
      "Description": "The name of AWS Secrets Manager secret. You need to create your secret under this name.",
      "Type": "String",
    },
    "SourceBucketsParameter": {
      "AllowedPattern": ".+",
      "Default": "defaultBucket, bucketNo2, bucketNo3, ...",
      "Description": "(Required) List the buckets (comma-separated) within your account that contain original image files. If you plan to use Thumbor or Custom image requests with this solution, the source bucket for those requests will be the first bucket listed in this field.",
      "Type": "String",
    },
  },
  "Resources": {
    "AppRegistry968496A3": {
      "Properties": {
        "Description": "Service Catalog application to track and manage all your resources for the solution sih",
        "Name": {
          "Fn::Join": [
            "-",
            [
              "AppRegistry",
              {
                "Ref": "AWS::StackName",
              },
              {
                "Ref": "AWS::Region",
              },
              {
                "Ref": "AWS::AccountId",
              },
            ],
          ],
        },
        "Tags": {
          "SolutionId": "S0ABC",
          "Solutions:ApplicationType": "AWS-Solutions",
          "Solutions:SolutionID": "S0ABC",
          "Solutions:SolutionName": "sih",
          "Solutions:SolutionVersion": "v6.2.5",
        },
      },
      "Type": "AWS::ServiceCatalogAppRegistry::Application",
    },
    "AppRegistryAssociation": {
      "Properties": {
        "Application": {
          "Fn::GetAtt": [
            "AppRegistry968496A3",
            "Id",
          ],
        },
        "Resource": {
          "Ref": "AWS::StackId",
        },
        "ResourceType": "CFN_STACK",
      },
      "Type": "AWS::ServiceCatalogAppRegistry::ResourceAssociation",
    },
    "BackEndARecordD2D9E3A6": {
      "Properties": {
        "AliasTarget": {
          "DNSName": {
            "Fn::GetAtt": [
              "BackEndImageHandlerCloudFrontApiGatewayLambdaCloudFrontToApiGatewayCloudFrontDistribution03AA31B2",
              "DomainName",
            ],
          },
          "HostedZoneId": {
            "Fn::FindInMap": [
              "AWSCloudFrontPartitionHostedZoneIdMap",
              {
                "Ref": "AWS::Partition",
              },
              "zoneId",
            ],
          },
        },
        "HostedZoneId": {
          "Fn::ImportValue": "HostedZoneTestStack2:ExportsOutputRefHostedZoneF1391A64D131F118",
        },
        "Name": "cdn.example.com.",
        "Type": "A",
      },
      "Type": "AWS::Route53::RecordSet",
    },
    "BackEndCachePolicy1DCE9B1B": {
      "Properties": {
        "CachePolicyConfig": {
          "DefaultTTL": 86400,
          "MaxTTL": 31536000,
          "MinTTL": 1,
          "Name": {
            "Fn::Join": [
              "",
              [
                "ServerlessImageHandler-",
                {
                  "Fn::GetAtt": [
                    "CommonResourcesCustomResourcesCustomResourceUuid64E7CCAD",
                    "UUID",
                  ],
                },
              ],
            ],
          },
          "ParametersInCacheKeyAndForwardedToOrigin": {
            "CookiesConfig": {
              "CookieBehavior": "none",
            },
            "EnableAcceptEncodingBrotli": false,
            "EnableAcceptEncodingGzip": false,
            "HeadersConfig": {
              "HeaderBehavior": "whitelist",
              "Headers": [
                "origin",
                "accept",
              ],
            },
            "QueryStringsConfig": {
              "QueryStringBehavior": "whitelist",
              "QueryStrings": [
                "signature",
                "edits",
                "headers",
                "effort",
                "outputFormat",
              ],
            },
          },
        },
      },
      "Type": "AWS::CloudFront::CachePolicy",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaApiAccessLogGroup9B786692": {
      "DeletionPolicy": "Retain",
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W84",
              "reason": "By default CloudWatchLogs LogGroups data is encrypted using the CloudWatch server-side encryption keys (AWS Managed Keys)",
            },
          ],
        },
      },
      "Properties": {
        "RetentionInDays": {
          "Ref": "LogRetentionPeriodParameter",
        },
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::Logs::LogGroup",
      "UpdateReplacePolicy": "Retain",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaCloudFrontToApiGatewayCloudFrontDistribution03AA31B2": {
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W70",
              "reason": "Since the distribution uses the CloudFront domain name, CloudFront automatically sets the security policy to TLSv1 regardless of the value of MinimumProtocolVersion",
            },
          ],
        },
      },
      "Properties": {
        "DistributionConfig": {
          "Aliases": [
            "cdn.example.com",
          ],
          "Comment": "Image Handler Distribution for Serverless Image Handler",
          "CustomErrorResponses": [
            {
              "ErrorCachingMinTTL": 600,
              "ErrorCode": 500,
            },
            {
              "ErrorCachingMinTTL": 600,
              "ErrorCode": 501,
            },
            {
              "ErrorCachingMinTTL": 600,
              "ErrorCode": 502,
            },
            {
              "ErrorCachingMinTTL": 600,
              "ErrorCode": 503,
            },
            {
              "ErrorCachingMinTTL": 600,
              "ErrorCode": 504,
            },
          ],
          "DefaultCacheBehavior": {
            "AllowedMethods": [
              "GET",
              "HEAD",
            ],
            "CachePolicyId": {
              "Ref": "BackEndCachePolicy1DCE9B1B",
            },
            "Compress": true,
            "FunctionAssociations": [
              {
                "EventType": "viewer-request",
                "FunctionARN": {
                  "Fn::GetAtt": [
                    "BackEndNormalizeAcceptHeaderFunctionA8503110",
                    "FunctionARN",
                  ],
                },
              },
            ],
            "OriginRequestPolicyId": {
              "Ref": "BackEndOriginRequestPolicy771345D7",
            },
            "TargetOriginId": "TestStack2BackEndImageHandlerCloudFrontApiGatewayLambdaCloudFrontToApiGatewayCloudFrontDistributionOrigin155978AA0",
            "ViewerProtocolPolicy": "https-only",
          },
          "Enabled": true,
          "HttpVersion": "http2",
          "IPV6Enabled": true,
          "Logging": {
            "Bucket": {
              "Fn::Join": [
                "",
                [
                  {
                    "Fn::GetAtt": [
                      "CommonResourcesCustomResourcesLogBucketCustomResource2445A3AB",
                      "BucketName",
                    ],
                  },
                  ".s3.",
                  {
                    "Fn::GetAtt": [
                      "CommonResourcesCustomResourcesLogBucketCustomResource2445A3AB",
                      "Region",
                    ],
                  },
                  ".",
                  {
                    "Ref": "AWS::URLSuffix",
                  },
                ],
              ],
            },
            "Prefix": "api-cloudfront/",
          },
          "Origins": [
            {
              "CustomOriginConfig": {
                "OriginProtocolPolicy": "https-only",
                "OriginSSLProtocols": [
                  "TLSv1.1",
                  "TLSv1.2",
                ],
              },
              "DomainName": {
                "Fn::Join": [
                  "",
                  [
                    {
                      "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
                    },
                    ".execute-api.",
                    {
                      "Ref": "AWS::Region",
                    },
                    ".amazonaws.com",
                  ],
                ],
              },
              "Id": "TestStack2BackEndImageHandlerCloudFrontApiGatewayLambdaCloudFrontToApiGatewayCloudFrontDistributionOrigin155978AA0",
              "OriginPath": "/image",
            },
          ],
          "PriceClass": {
            "Ref": "CloudFrontPriceClassParameter",
          },
          "ViewerCertificate": {
            "AcmCertificateArn": {
              "Fn::ImportValue": "CertificateTestStack2:ExportsOutputRefCertificateCustomCertificateDCB38E29AA887361",
            },
            "MinimumProtocolVersion": "TLSv1.2_2021",
            "SslSupportMethod": "sni-only",
          },
        },
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::CloudFront::Distribution",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109": {
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W59",
              "reason": "AWS::ApiGateway::Method AuthorizationType is set to 'NONE' because API Gateway behind CloudFront does not support AWS_IAM authentication",
            },
          ],
        },
      },
      "Properties": {
        "BinaryMediaTypes": [
          "*/*",
        ],
        "EndpointConfiguration": {
          "Types": [
            "REGIONAL",
          ],
        },
        "Name": "LambdaRestApi",
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::ApiGateway::RestApi",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiANYApiPermissionTestStack2BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi025FAF67ANYE358A578": {
      "Properties": {
        "Action": "lambda:InvokeFunction",
        "FunctionName": {
          "Fn::GetAtt": [
            "BackEndImageHandlerLambdaFunctionADEF7FF2",
            "Arn",
          ],
        },
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": {
          "Fn::Join": [
            "",
            [
              "arn:",
              {
                "Ref": "AWS::Partition",
              },
              ":execute-api:us-east-1:",
              {
                "Ref": "AWS::AccountId",
              },
              ":",
              {
                "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
              },
              "/",
              {
                "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiDeploymentStageimageB55D20E3",
              },
              "/*/",
            ],
          ],
        },
      },
      "Type": "AWS::Lambda::Permission",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiANYApiPermissionTestTestStack2BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi025FAF67ANY53A27994": {
      "Properties": {
        "Action": "lambda:InvokeFunction",
        "FunctionName": {
          "Fn::GetAtt": [
            "BackEndImageHandlerLambdaFunctionADEF7FF2",
            "Arn",
          ],
        },
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": {
          "Fn::Join": [
            "",
            [
              "arn:",
              {
                "Ref": "AWS::Partition",
              },
              ":execute-api:us-east-1:",
              {
                "Ref": "AWS::AccountId",
              },
              ":",
              {
                "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
              },
              "/test-invoke-stage/*/",
            ],
          ],
        },
      },
      "Type": "AWS::Lambda::Permission",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiANYE4494B31": {
      "Properties": {
        "AuthorizationType": "NONE",
        "HttpMethod": "ANY",
        "Integration": {
          "IntegrationHttpMethod": "POST",
          "Type": "AWS_PROXY",
          "Uri": {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":apigateway:us-east-1:lambda:path/2015-03-31/functions/",
                {
                  "Fn::GetAtt": [
                    "BackEndImageHandlerLambdaFunctionADEF7FF2",
                    "Arn",
                  ],
                },
                "/invocations",
              ],
            ],
          },
        },
        "ResourceId": {
          "Fn::GetAtt": [
            "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
            "RootResourceId",
          ],
        },
        "RestApiId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
        },
      },
      "Type": "AWS::ApiGateway::Method",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiAccountE5522E5D": {
      "DependsOn": [
        "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
      ],
      "Properties": {
        "CloudWatchRoleArn": {
          "Fn::GetAtt": [
            "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiCloudWatchRole12575C4D",
            "Arn",
          ],
        },
      },
      "Type": "AWS::ApiGateway::Account",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiCloudWatchRole12575C4D": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "apigateway.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "Policies": [
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:DescribeLogGroups",
                    "logs:DescribeLogStreams",
                    "logs:PutLogEvents",
                    "logs:GetLogEvents",
                    "logs:FilterLogEvents",
                  ],
                  "Effect": "Allow",
                  "Resource": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:",
                        {
                          "Ref": "AWS::Partition",
                        },
                        ":logs:",
                        {
                          "Ref": "AWS::Region",
                        },
                        ":",
                        {
                          "Ref": "AWS::AccountId",
                        },
                        ":*",
                      ],
                    ],
                  },
                },
              ],
              "Version": "2012-10-17",
            },
            "PolicyName": "LambdaRestApiCloudWatchRolePolicy",
          },
        ],
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiDeployment663240D632845ea3256893edc3e56ab8761be32c": {
      "DependsOn": [
        "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyANY8F9763E1",
        "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyBDF0A131",
        "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiANYE4494B31",
      ],
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W45",
              "reason": "ApiGateway has AccessLogging enabled in AWS::ApiGateway::Stage resource, but cfn_nag checks for it in AWS::ApiGateway::Deployment resource",
            },
          ],
        },
      },
      "Properties": {
        "Description": "Automatically created by the RestApi construct",
        "RestApiId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
        },
      },
      "Type": "AWS::ApiGateway::Deployment",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiDeploymentStageimageB55D20E3": {
      "Properties": {
        "AccessLogSetting": {
          "DestinationArn": {
            "Fn::GetAtt": [
              "BackEndImageHandlerCloudFrontApiGatewayLambdaApiAccessLogGroup9B786692",
              "Arn",
            ],
          },
          "Format": "{"requestId":"$context.requestId","ip":"$context.identity.sourceIp","user":"$context.identity.user","caller":"$context.identity.caller","requestTime":"$context.requestTime","httpMethod":"$context.httpMethod","resourcePath":"$context.resourcePath","status":"$context.status","protocol":"$context.protocol","responseLength":"$context.responseLength"}",
        },
        "DeploymentId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiDeployment663240D632845ea3256893edc3e56ab8761be32c",
        },
        "MethodSettings": [
          {
            "DataTraceEnabled": false,
            "HttpMethod": "*",
            "LoggingLevel": "INFO",
            "ResourcePath": "/*",
          },
        ],
        "RestApiId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
        },
        "StageName": "image",
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
        "TracingEnabled": true,
      },
      "Type": "AWS::ApiGateway::Stage",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiUsagePlan76CA1E70": {
      "Properties": {
        "ApiStages": [
          {
            "ApiId": {
              "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
            },
            "Stage": {
              "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiDeploymentStageimageB55D20E3",
            },
            "Throttle": {},
          },
        ],
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::ApiGateway::UsagePlan",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyANY8F9763E1": {
      "Properties": {
        "AuthorizationType": "NONE",
        "HttpMethod": "ANY",
        "Integration": {
          "IntegrationHttpMethod": "POST",
          "Type": "AWS_PROXY",
          "Uri": {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":apigateway:us-east-1:lambda:path/2015-03-31/functions/",
                {
                  "Fn::GetAtt": [
                    "BackEndImageHandlerLambdaFunctionADEF7FF2",
                    "Arn",
                  ],
                },
                "/invocations",
              ],
            ],
          },
        },
        "ResourceId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyBDF0A131",
        },
        "RestApiId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
        },
      },
      "Type": "AWS::ApiGateway::Method",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyANYApiPermissionTestStack2BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi025FAF67ANYproxy09A0A6FA": {
      "Properties": {
        "Action": "lambda:InvokeFunction",
        "FunctionName": {
          "Fn::GetAtt": [
            "BackEndImageHandlerLambdaFunctionADEF7FF2",
            "Arn",
          ],
        },
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": {
          "Fn::Join": [
            "",
            [
              "arn:",
              {
                "Ref": "AWS::Partition",
              },
              ":execute-api:us-east-1:",
              {
                "Ref": "AWS::AccountId",
              },
              ":",
              {
                "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
              },
              "/",
              {
                "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiDeploymentStageimageB55D20E3",
              },
              "/*/*",
            ],
          ],
        },
      },
      "Type": "AWS::Lambda::Permission",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyANYApiPermissionTestTestStack2BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi025FAF67ANYproxyF4C25741": {
      "Properties": {
        "Action": "lambda:InvokeFunction",
        "FunctionName": {
          "Fn::GetAtt": [
            "BackEndImageHandlerLambdaFunctionADEF7FF2",
            "Arn",
          ],
        },
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": {
          "Fn::Join": [
            "",
            [
              "arn:",
              {
                "Ref": "AWS::Partition",
              },
              ":execute-api:us-east-1:",
              {
                "Ref": "AWS::AccountId",
              },
              ":",
              {
                "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
              },
              "/test-invoke-stage/*/*",
            ],
          ],
        },
      },
      "Type": "AWS::Lambda::Permission",
    },
    "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApiproxyBDF0A131": {
      "Properties": {
        "ParentId": {
          "Fn::GetAtt": [
            "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
            "RootResourceId",
          ],
        },
        "PathPart": "{proxy+}",
        "RestApiId": {
          "Ref": "BackEndImageHandlerCloudFrontApiGatewayLambdaLambdaRestApi5A77D109",
        },
      },
      "Type": "AWS::ApiGateway::Resource",
    },
    "BackEndImageHandlerFunctionPolicy437940B5": {
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W12",
              "reason": "rekognition:DetectFaces requires '*' resources.",
            },
          ],
        },
      },
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents",
              ],
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition",
                    },
                    ":logs:us-east-1:",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    ":log-group:/aws/lambda/*",
                  ],
                ],
              },
            },
            {
              "Action": [
                "s3:GetObject",
                "s3:PutObject",
                "s3:ListBucket",
              ],
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition",
                    },
                    ":s3:::*",
                  ],
                ],
              },
            },
            {
              "Action": [
                "rekognition:DetectFaces",
                "rekognition:DetectModerationLabels",
              ],
              "Effect": "Allow",
              "Resource": "*",
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "BackEndImageHandlerFunctionPolicy437940B5",
        "Roles": [
          {
            "Ref": "BackEndImageHandlerFunctionRoleABF81E5C",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "BackEndImageHandlerFunctionRoleABF81E5C": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "Path": "/",
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "BackEndImageHandlerLambdaFunctionADEF7FF2": {
      "DependsOn": [
        "BackEndImageHandlerFunctionRoleABF81E5C",
      ],
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W58",
              "reason": "The function does have permission to write CloudWatch Logs.",
            },
            {
              "id": "W89",
              "reason": "The Lambda function does not require any VPC connection at all.",
            },
            {
              "id": "W92",
              "reason": "The Lambda function does not require ReservedConcurrentExecutions.",
            },
          ],
        },
      },
      "Properties": {
        "Code": {
          "S3Bucket": {
            "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-us-east-1",
          },
          "S3Key": "Omitted to remove snapshot dependency on hash",
        },
        "Description": "sih (v6.2.5): Performs image edits and manipulations",
        "Environment": {
          "Variables": {
            "AUTO_WEBP": {
              "Ref": "AutoWebPParameter",
            },
            "AWS_NODEJS_CONNECTION_REUSE_ENABLED": "1",
            "CORS_ENABLED": {
              "Ref": "CorsEnabledParameter",
            },
            "CORS_ORIGIN": {
              "Ref": "CorsOriginParameter",
            },
            "DEFAULT_FALLBACK_IMAGE_BUCKET": {
              "Ref": "FallbackImageS3BucketParameter",
            },
            "DEFAULT_FALLBACK_IMAGE_KEY": {
              "Ref": "FallbackImageS3KeyParameter",
            },
            "ENABLE_DEFAULT_FALLBACK_IMAGE": {
              "Ref": "EnableDefaultFallbackImageParameter",
            },
            "ENABLE_SIGNATURE": {
              "Ref": "EnableSignatureParameter",
            },
            "REWRITE_MATCH_PATTERN": "",
            "REWRITE_SUBSTITUTION": "",
            "SECRETS_MANAGER": {
              "Ref": "SecretsManagerSecretParameter",
            },
            "SECRET_KEY": {
              "Ref": "SecretsManagerKeyParameter",
            },
            "SOURCE_BUCKETS": {
              "Ref": "SourceBucketsParameter",
            },
          },
        },
        "Handler": "index.handler",
        "MemorySize": 1024,
        "Role": {
          "Fn::GetAtt": [
            "BackEndImageHandlerFunctionRoleABF81E5C",
            "Arn",
          ],
        },
        "Runtime": "nodejs20.x",
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
        "Timeout": 29,
      },
      "Type": "AWS::Lambda::Function",
    },
    "BackEndImageHandlerLogGroupA0941EEC": {
      "DeletionPolicy": "Retain",
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W84",
              "reason": "CloudWatch log group is always encrypted by default.",
            },
          ],
        },
      },
      "Properties": {
        "LogGroupName": {
          "Fn::Join": [
            "",
            [
              "/aws/lambda/",
              {
                "Ref": "BackEndImageHandlerLambdaFunctionADEF7FF2",
              },
            ],
          ],
        },
        "RetentionInDays": {
          "Ref": "LogRetentionPeriodParameter",
        },
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::Logs::LogGroup",
      "UpdateReplacePolicy": "Retain",
    },
    "BackEndNormalizeAcceptHeaderFunctionA8503110": {
      "Properties": {
        "AutoPublish": true,
        "FunctionCode": "
function handler(event) {
  if (event.request.headers && event.request.headers.accept && event.request.headers.accept.value) {
    let resultingHeader = "image/jpg";
    const acceptheadervalue = event.request.headers.accept.value;
    if (acceptheadervalue.includes("image/webp")) {
      resultingHeader = "image/webp";
    }
    event.request.headers.accept = { value: resultingHeader };
  }
  return event.request;
}
",
        "FunctionConfig": {
          "Comment": {
            "Fn::Join": [
              "",
              [
                "normalize-accept-headers-",
                {
                  "Ref": "AWS::Region",
                },
              ],
            ],
          },
          "Runtime": "cloudfront-js-1.0",
        },
        "Name": {
          "Fn::Join": [
            "",
            [
              "normalize-accept-headers-",
              {
                "Ref": "AWS::Region",
              },
            ],
          ],
        },
      },
      "Type": "AWS::CloudFront::Function",
    },
    "BackEndOriginRequestPolicy771345D7": {
      "Properties": {
        "OriginRequestPolicyConfig": {
          "CookiesConfig": {
            "CookieBehavior": "none",
          },
          "HeadersConfig": {
            "HeaderBehavior": "whitelist",
            "Headers": [
              "origin",
              "accept",
            ],
          },
          "Name": {
            "Fn::Join": [
              "",
              [
                "ServerlessImageHandler-",
                {
                  "Fn::GetAtt": [
                    "CommonResourcesCustomResourcesCustomResourceUuid64E7CCAD",
                    "UUID",
                  ],
                },
              ],
            ],
          },
          "QueryStringsConfig": {
            "QueryStringBehavior": "whitelist",
            "QueryStrings": [
              "signature",
              "edits",
              "headers",
              "effort",
              "outputFormat",
            ],
          },
        },
      },
      "Type": "AWS::CloudFront::OriginRequestPolicy",
    },
    "CommonResourcesCustomResourcesCustomResourceAnonymousMetric51363F57": {
      "DeletionPolicy": "Delete",
      "Properties": {
        "AnonymousData": "No",
        "AutoWebP": {
          "Ref": "AutoWebPParameter",
        },
        "CorsEnabled": {
          "Ref": "CorsEnabledParameter",
        },
        "CustomAction": "sendMetric",
        "CustomDomain": "cdn.example.com",
        "DeployDemoUi": {
          "Ref": "DeployDemoUIParameter",
        },
        "EnableDefaultFallbackImage": {
          "Ref": "EnableDefaultFallbackImageParameter",
        },
        "EnableSignature": {
          "Ref": "EnableSignatureParameter",
        },
        "LogRetentionPeriod": {
          "Ref": "LogRetentionPeriodParameter",
        },
        "Region": {
          "Ref": "AWS::Region",
        },
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
        "SourceBuckets": {
          "Ref": "SourceBucketsParameter",
        },
        "UUID": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceUuid64E7CCAD",
            "UUID",
          ],
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesCustomResourceCheckFallbackImage6CE45571": {
      "Condition": "CommonResourcesEnableDefaultFallbackImageConditionD1A10983",
      "DeletionPolicy": "Delete",
      "Properties": {
        "CustomAction": "checkFallbackImage",
        "FallbackImageS3Bucket": {
          "Ref": "FallbackImageS3BucketParameter",
        },
        "FallbackImageS3Key": {
          "Ref": "FallbackImageS3KeyParameter",
        },
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesCustomResourceCheckSecretsManagerAEEEC776": {
      "Condition": "CommonResourcesEnableSignatureCondition909DC7A1",
      "DeletionPolicy": "Delete",
      "Properties": {
        "CustomAction": "checkSecretsManager",
        "SecretsManagerKey": {
          "Ref": "SecretsManagerKeyParameter",
        },
        "SecretsManagerName": {
          "Ref": "SecretsManagerSecretParameter",
        },
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesCustomResourceCheckSourceBucketsA313C9B7": {
      "DeletionPolicy": "Delete",
      "Properties": {
        "CustomAction": "checkSourceBuckets",
        "Region": {
          "Ref": "AWS::Region",
        },
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
        "SourceBuckets": {
          "Ref": "SourceBucketsParameter",
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesCustomResourceFunction0D924235": {
      "DependsOn": [
        "CommonResourcesCustomResourcesCustomResourceRole8958A1ED",
      ],
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W58",
              "reason": "The function does have permission to write CloudWatch Logs.",
            },
            {
              "id": "W89",
              "reason": "The Lambda function does not require any VPC connection at all.",
            },
            {
              "id": "W92",
              "reason": "The Lambda function does not require ReservedConcurrentExecutions.",
            },
          ],
        },
      },
      "Properties": {
        "Code": {
          "S3Bucket": {
            "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-us-east-1",
          },
          "S3Key": "Omitted to remove snapshot dependency on hash",
        },
        "Description": "sih (v6.2.5): Custom resource",
        "Environment": {
          "Variables": {
            "AWS_NODEJS_CONNECTION_REUSE_ENABLED": "1",
            "RETRY_SECONDS": "5",
            "SOLUTION_ID": "S0ABC",
            "SOLUTION_VERSION": "v6.2.5",
          },
        },
        "Handler": "index.handler",
        "MemorySize": 128,
        "Role": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceRole8958A1ED",
            "Arn",
          ],
        },
        "Runtime": "nodejs20.x",
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
        "Timeout": 60,
      },
      "Type": "AWS::Lambda::Function",
    },
    "CommonResourcesCustomResourcesCustomResourceRole8958A1ED": {
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W11",
              "reason": "Allow '*' because it is required for making DescribeRegions API call as it doesn't support resource-level permissions and require to choose all resources.",
            },
          ],
        },
      },
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "Path": "/",
        "Policies": [
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents",
                  ],
                  "Effect": "Allow",
                  "Resource": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:",
                        {
                          "Ref": "AWS::Partition",
                        },
                        ":logs:us-east-1:",
                        {
                          "Ref": "AWS::AccountId",
                        },
                        ":log-group:/aws/lambda/*",
                      ],
                    ],
                  },
                },
                {
                  "Action": [
                    "s3:putBucketAcl",
                    "s3:putEncryptionConfiguration",
                    "s3:putBucketPolicy",
                    "s3:CreateBucket",
                    "s3:GetObject",
                    "s3:PutObject",
                    "s3:ListBucket",
                    "s3:PutBucketOwnershipControls",
                  ],
                  "Effect": "Allow",
                  "Resource": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:",
                        {
                          "Ref": "AWS::Partition",
                        },
                        ":s3:::*",
                      ],
                    ],
                  },
                },
              ],
              "Version": "2012-10-17",
            },
            "PolicyName": "CloudWatchLogsPolicy",
          },
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": "ec2:DescribeRegions",
                  "Effect": "Allow",
                  "Resource": "*",
                },
              ],
              "Version": "2012-10-17",
            },
            "PolicyName": "EC2Policy",
          },
        ],
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "CommonResourcesCustomResourcesCustomResourceUuid64E7CCAD": {
      "DeletionPolicy": "Delete",
      "Properties": {
        "CustomAction": "createUuid",
        "Region": {
          "Ref": "AWS::Region",
        },
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesDeployWebsiteAwsCliLayerBC025F39": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Properties": {
        "Content": {
          "S3Bucket": {
            "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-us-east-1",
          },
          "S3Key": "Omitted to remove snapshot dependency on hash",
        },
        "Description": "/opt/awscli/aws",
      },
      "Type": "AWS::Lambda::LayerVersion",
    },
    "CommonResourcesCustomResourcesDeployWebsiteCustomResourceECB9B136": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "DeletionPolicy": "Delete",
      "Properties": {
        "DestinationBucketName": {
          "Ref": "FrontEndDistributionToS3S3Bucket3A171D78",
        },
        "Exclude": [
          "demo-ui-config.js",
        ],
        "Prune": true,
        "ServiceToken": {
          "Fn::GetAtt": [
            "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756C81C01536",
            "Arn",
          ],
        },
        "SourceBucketNames": [
          {
            "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-us-east-1",
          },
        ],
        "SourceObjectKeys": [
          "c301c2cce52bb1b36720a115d657907f3ec9fa20bd385b4d81bf451fbe77fe4b.zip",
        ],
      },
      "Type": "Custom::CDKBucketDeployment",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesLogBucketCustomResource2445A3AB": {
      "DeletionPolicy": "Delete",
      "Properties": {
        "BucketSuffix": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AWS::StackName",
              },
              "-",
              {
                "Ref": "AWS::Region",
              },
              "-",
              {
                "Ref": "AWS::AccountId",
              },
            ],
          ],
        },
        "CustomAction": "createCloudFrontLoggingBucket",
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesCustomResourcesPutWebsiteConfigC4E435F3": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "DeletionPolicy": "Delete",
      "Properties": {
        "ConfigItem": {
          "apiEndpoint": {
            "Fn::Join": [
              "",
              [
                "https://",
                {
                  "Fn::GetAtt": [
                    "BackEndImageHandlerCloudFrontApiGatewayLambdaCloudFrontToApiGatewayCloudFrontDistribution03AA31B2",
                    "DomainName",
                  ],
                },
              ],
            ],
          },
        },
        "CustomAction": "putConfigFile",
        "DestS3Bucket": {
          "Ref": "FrontEndDistributionToS3S3Bucket3A171D78",
        },
        "DestS3key": "demo-ui-config.js",
        "Region": {
          "Ref": "AWS::Region",
        },
        "ServiceToken": {
          "Fn::GetAtt": [
            "CommonResourcesCustomResourcesCustomResourceFunction0D924235",
            "Arn",
          ],
        },
      },
      "Type": "AWS::CloudFormation::CustomResource",
      "UpdateReplacePolicy": "Delete",
    },
    "CommonResourcesSecretsManagerPolicy45FE005E": {
      "Condition": "CommonResourcesEnableSignatureCondition909DC7A1",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "secretsmanager:GetSecretValue",
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition",
                    },
                    ":secretsmanager:",
                    {
                      "Ref": "AWS::Region",
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    ":secret:",
                    {
                      "Ref": "SecretsManagerSecretParameter",
                    },
                    "*",
                  ],
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "CommonResourcesSecretsManagerPolicy45FE005E",
        "Roles": [
          {
            "Ref": "CommonResourcesCustomResourcesCustomResourceRole8958A1ED",
          },
          {
            "Ref": "BackEndImageHandlerFunctionRoleABF81E5C",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756C81C01536": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "DependsOn": [
        "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRoleDefaultPolicy88902FDF",
        "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRole89A01265",
      ],
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W58",
              "reason": "The function does have permission to write CloudWatch Logs.",
            },
            {
              "id": "W89",
              "reason": "The Lambda function does not require any VPC connection at all.",
            },
            {
              "id": "W92",
              "reason": "The Lambda function does not require ReservedConcurrentExecutions.",
            },
          ],
        },
      },
      "Properties": {
        "Code": {
          "S3Bucket": {
            "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-us-east-1",
          },
          "S3Key": "Omitted to remove snapshot dependency on hash",
        },
        "Environment": {
          "Variables": {
            "AWS_CA_BUNDLE": "/etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem",
          },
        },
        "Handler": "index.handler",
        "Layers": [
          {
            "Ref": "CommonResourcesCustomResourcesDeployWebsiteAwsCliLayerBC025F39",
          },
        ],
        "Role": {
          "Fn::GetAtt": [
            "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRole89A01265",
            "Arn",
          ],
        },
        "Runtime": "python3.9",
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
        "Timeout": 900,
      },
      "Type": "AWS::Lambda::Function",
    },
    "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRole89A01265": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
        ],
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRoleDefaultPolicy88902FDF": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "s3:GetObject*",
                "s3:GetBucket*",
                "s3:List*",
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-us-east-1",
                      },
                    ],
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-us-east-1",
                      },
                      "/*",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": [
                "s3:GetObject*",
                "s3:GetBucket*",
                "s3:List*",
                "s3:DeleteObject*",
                "s3:PutObject",
                "s3:PutObjectLegalHold",
                "s3:PutObjectRetention",
                "s3:PutObjectTagging",
                "s3:PutObjectVersionTagging",
                "s3:Abort*",
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "FrontEndDistributionToS3S3Bucket3A171D78",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "FrontEndDistributionToS3S3Bucket3A171D78",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRoleDefaultPolicy88902FDF",
        "Roles": [
          {
            "Ref": "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRole89A01265",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "DefaultApplicationAttributeGroup41AD7209": {
      "Properties": {
        "Attributes": {
          "applicationType": "AWS-Solutions",
          "solutionID": "S0ABC",
          "solutionName": "sih",
          "version": "v6.2.5",
        },
        "Description": "Attribute group for solution information",
        "Name": {
          "Fn::Join": [
            "",
            [
              "A30-AppRegistry-",
              {
                "Ref": "AWS::StackName",
              },
            ],
          ],
        },
        "Tags": {
          "SolutionId": "S0ABC",
        },
      },
      "Type": "AWS::ServiceCatalogAppRegistry::AttributeGroup",
    },
    "DefaultApplicationAttributeGroupApplicationAttributeGroupAssociationbeba6d257793C48D7841": {
      "Properties": {
        "Application": {
          "Fn::GetAtt": [
            "AppRegistry968496A3",
            "Id",
          ],
        },
        "AttributeGroup": {
          "Fn::GetAtt": [
            "DefaultApplicationAttributeGroup41AD7209",
            "Id",
          ],
        },
      },
      "Type": "AWS::ServiceCatalogAppRegistry::AttributeGroupAssociation",
    },
    "FrontEndDistributionToS3CloudFrontDistribution15FE13D0": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W70",
              "reason": "Since the distribution uses the CloudFront domain name, CloudFront automatically sets the security policy to TLSv1 regardless of the value of MinimumProtocolVersion",
            },
          ],
        },
      },
      "Properties": {
        "DistributionConfig": {
          "Comment": "Demo UI Distribution for Serverless Image Handler",
          "CustomErrorResponses": [
            {
              "ErrorCode": 403,
              "ResponseCode": 200,
              "ResponsePagePath": "/index.html",
            },
            {
              "ErrorCode": 404,
              "ResponseCode": 200,
              "ResponsePagePath": "/index.html",
            },
          ],
          "DefaultCacheBehavior": {
            "CachePolicyId": "658327ea-f89d-4fab-a63d-7e88639e58f6",
            "Compress": true,
            "TargetOriginId": "TestStack2FrontEndDistributionToS3CloudFrontDistributionOrigin1C00BF3E2",
            "ViewerProtocolPolicy": "redirect-to-https",
          },
          "DefaultRootObject": "index.html",
          "Enabled": true,
          "HttpVersion": "http2",
          "IPV6Enabled": true,
          "Logging": {
            "Bucket": {
              "Fn::Join": [
                "",
                [
                  {
                    "Fn::GetAtt": [
                      "CommonResourcesCustomResourcesLogBucketCustomResource2445A3AB",
                      "BucketName",
                    ],
                  },
                  ".s3.",
                  {
                    "Fn::GetAtt": [
                      "CommonResourcesCustomResourcesLogBucketCustomResource2445A3AB",
                      "Region",
                    ],
                  },
                  ".",
                  {
                    "Ref": "AWS::URLSuffix",
                  },
                ],
              ],
            },
            "Prefix": "ui-cloudfront/",
          },
          "Origins": [
            {
              "DomainName": {
                "Fn::GetAtt": [
                  "FrontEndDistributionToS3S3Bucket3A171D78",
                  "RegionalDomainName",
                ],
              },
              "Id": "TestStack2FrontEndDistributionToS3CloudFrontDistributionOrigin1C00BF3E2",
              "S3OriginConfig": {
                "OriginAccessIdentity": {
                  "Fn::Join": [
                    "",
                    [
                      "origin-access-identity/cloudfront/",
                      {
                        "Ref": "FrontEndDistributionToS3CloudFrontDistributionOrigin1S3OriginD10E575E",
                      },
                    ],
                  ],
                },
              },
            },
          ],
        },
        "Tags": [
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
      },
      "Type": "AWS::CloudFront::Distribution",
    },
    "FrontEndDistributionToS3CloudFrontDistributionOrigin1S3OriginD10E575E": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Properties": {
        "CloudFrontOriginAccessIdentityConfig": {
          "Comment": "Identity for TestStack2FrontEndDistributionToS3CloudFrontDistributionOrigin1C00BF3E2",
        },
      },
      "Type": "AWS::CloudFront::CloudFrontOriginAccessIdentity",
    },
    "FrontEndDistributionToS3S3Bucket3A171D78": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "DeletionPolicy": "Retain",
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "W35",
              "reason": "This S3 bucket does not require access logging.",
            },
          ],
        },
      },
      "Properties": {
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256",
              },
            },
          ],
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "NoncurrentVersionTransitions": [
                {
                  "StorageClass": "GLACIER",
                  "TransitionInDays": 90,
                },
              ],
              "Status": "Enabled",
            },
          ],
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true,
        },
        "Tags": [
          {
            "Key": "aws-cdk:cr-owned:5fc5e6e7",
            "Value": "true",
          },
          {
            "Key": "SolutionId",
            "Value": "S0ABC",
          },
        ],
        "VersioningConfiguration": {
          "Status": "Enabled",
        },
      },
      "Type": "AWS::S3::Bucket",
      "UpdateReplacePolicy": "Retain",
    },
    "FrontEndDistributionToS3S3BucketPolicyF3A0315A": {
      "Condition": "CommonResourcesDeployDemoUICondition308D3B09",
      "Metadata": {
        "cfn_nag": {
          "rules_to_suppress": [
            {
              "id": "F16",
              "reason": "Public website bucket policy requires a wildcard principal",
            },
          ],
        },
      },
      "Properties": {
        "Bucket": {
          "Ref": "FrontEndDistributionToS3S3Bucket3A171D78",
        },
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:*",
              "Condition": {
                "Bool": {
                  "aws:SecureTransport": "false",
                },
              },
              "Effect": "Deny",
              "Principal": {
                "AWS": "*",
              },
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "FrontEndDistributionToS3S3Bucket3A171D78",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "FrontEndDistributionToS3S3Bucket3A171D78",
                          "Arn",
                        ],
                      },
                      "/*",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": "s3:GetObject",
              "Effect": "Allow",
              "Principal": {
                "CanonicalUser": {
                  "Fn::GetAtt": [
                    "FrontEndDistributionToS3CloudFrontDistributionOrigin1S3OriginD10E575E",
                    "S3CanonicalUserId",
                  ],
                },
              },
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    {
                      "Fn::GetAtt": [
                        "FrontEndDistributionToS3S3Bucket3A171D78",
                        "Arn",
                      ],
                    },
                    "/*",
                  ],
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::S3::BucketPolicy",
    },
  },
  "Rules": {
    "CheckBootstrapVersion": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Contains": [
                  [
                    "1",
                    "2",
                    "3",
                    "4",
                    "5",
                  ],
                  {
                    "Ref": "BootstrapVersion",
                  },
                ],
              },
            ],
          },
          "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI.",
        },
      ],
    },
  },
}
`;
